<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PropFlow ‚Äî Real Estate CRM</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üî• YOUR FIREBASE CONFIG ‚Äî Replace with yours
  // Go to: console.firebase.google.com
  // ‚Üí Create project ‚Üí Add Web App ‚Üí Copy config
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const firebaseConfig = {
  apiKey: "AIzaSyAz-44QWWH4lcXu9I7Xs56RCsjSbmSHNuo",
  authDomain: "fir-config-9023d.firebaseapp.com",
  projectId: "fir-config-9023d",
  storageBucket: "fir-config-9023d.firebasestorage.app",
  messagingSenderId: "178665965729",
  appId: "1:178665965729:web:57fcb0f607a1420c8e08e0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ‚îÄ‚îÄ expose globally so non-module scripts can use ‚îÄ‚îÄ
  window._db = db;
  window._firebase = { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot, serverTimestamp, where };

  window.addEventListener('DOMContentLoaded', () => {
    initApp();
  });
</script>

<style>
:root {
  --bg:#0f0e0c; --bg2:#161410; --bg3:#1e1b16; --bg4:#26221b; --bg5:#2e2920;
  --border:rgba(255,220,140,0.08); --border2:rgba(255,220,140,0.16);
  --gold:#d4a843; --gold2:#f0c96a; --gold-dim:rgba(212,168,67,0.12); --gold-glow:rgba(212,168,67,0.22);
  --text:#f0ead8; --text2:#9a9080; --text3:#5a5045;
  --green:#4caf7d; --green-dim:rgba(76,175,125,0.12);
  --red:#e05555; --red-dim:rgba(224,85,85,0.12);
  --blue:#6ba3d6; --blue-dim:rgba(107,163,214,0.12);
  --orange:#e8924a; --orange-dim:rgba(232,146,74,0.12);
  --r:10px; --r-sm:7px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;}

/* ‚îÄ‚îÄ SETUP BANNER ‚îÄ‚îÄ */
.setup-banner {
  background: linear-gradient(90deg, rgba(212,168,67,0.15), rgba(212,168,67,0.05));
  border-bottom: 1px solid rgba(212,168,67,0.3);
  padding: 8px 18px;
  display: flex; align-items: center; gap: 10px;
  font-size: 12px; color: var(--gold2);
  flex-shrink: 0;
}
.setup-banner a { color: var(--gold); font-weight: 700; text-decoration: underline; cursor: pointer; }
.setup-banner .dismiss { margin-left: auto; cursor: pointer; color: var(--text3); font-size: 14px; }

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar{height:54px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 18px;gap:14px;flex-shrink:0;z-index:100;}
.logo{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--gold2);letter-spacing:.02em;display:flex;align-items:center;gap:8px;cursor:pointer;flex-shrink:0;}
.logo-icon{width:30px;height:30px;background:linear-gradient(135deg,var(--gold),var(--gold2));border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:14px;color:#0f0e0c;font-weight:700;}
.top-search{flex:1;max-width:340px;margin:0 10px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;padding:0 12px;gap:8px;height:34px;}
.top-search input{background:none;border:none;outline:none;color:var(--text);font-family:inherit;font-size:13px;width:100%;}
.top-search input::placeholder{color:var(--text3);}
.top-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
.t-btn{height:32px;padding:0 14px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);font-family:inherit;font-size:12px;font-weight:500;border-radius:7px;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .2s;}
.t-btn:hover{border-color:var(--border2);color:var(--text);background:var(--bg4);}
.t-btn.gold{background:var(--gold-dim);border-color:rgba(212,168,67,.3);color:var(--gold);}
.t-btn.gold:hover{background:var(--gold-glow);}
.notif-btn{width:32px;height:32px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text2);transition:all .2s;position:relative;}
.notif-badge{position:absolute;top:-3px;right:-3px;width:15px;height:15px;background:var(--red);border-radius:50%;font-size:8px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;border:2px solid var(--bg2);}
.avatar{width:32px;height:32px;background:linear-gradient(135deg,#8b4513,var(--gold));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;cursor:pointer;flex-shrink:0;}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.app-body{flex:1;display:flex;overflow:hidden;}

/* ‚îÄ‚îÄ SIDENAV ‚îÄ‚îÄ */
.sidenav{width:220px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:14px 10px;gap:2px;flex-shrink:0;overflow-y:auto;}
.sidenav::-webkit-scrollbar{width:0;}
.nav-section-label{font-size:10px;font-weight:600;letter-spacing:.1em;color:var(--text3);text-transform:uppercase;padding:10px 10px 4px;margin-top:4px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:8px;cursor:pointer;color:var(--text2);font-size:13px;font-weight:500;transition:all .15s;position:relative;}
.nav-item:hover{background:var(--bg3);color:var(--text);}
.nav-item.active{background:var(--gold-dim);color:var(--gold);}
.nav-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:20px;background:var(--gold);border-radius:0 2px 2px 0;}
.nav-item svg{flex-shrink:0;}
.nav-badge{margin-left:auto;font-size:10px;font-weight:700;background:var(--bg4);color:var(--text2);padding:1px 6px;border-radius:20px;min-width:18px;text-align:center;}
.nav-badge.hot{background:var(--red-dim);color:var(--red);}
.nav-badge.new{background:var(--green-dim);color:var(--green);}
.nav-divider{height:1px;background:var(--border);margin:8px 0;}
.nav-spacer{flex:1;}
.nav-agent-card{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px;margin-top:4px;}
.nac-top{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.nac-avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,#8b4513,var(--gold));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0;}
.nac-name{font-size:12px;font-weight:600;color:var(--text);}
.nac-role{font-size:10px;color:var(--text3);}
.nac-stats{display:flex;gap:8px;}
.nac-stat{flex:1;text-align:center;}
.nac-stat-val{font-size:14px;font-weight:700;color:var(--gold);}
.nac-stat-lbl{font-size:9px;color:var(--text3);}

/* ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ */
.main{flex:1;overflow-y:auto;display:flex;flex-direction:column;min-width:0;}
.main::-webkit-scrollbar{width:6px;}
.main::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px;}
.view{display:none;flex:1;flex-direction:column;overflow:hidden;}
.view.active{display:flex;}
.page-header{padding:20px 24px 0;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.page-title h1{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:700;color:var(--text);letter-spacing:.01em;}
.page-title p{font-size:13px;color:var(--text2);margin-top:2px;}
.page-actions{display:flex;gap:8px;align-items:center;}

/* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
.dash-content{padding:20px 24px;flex:1;overflow-y:auto;}
.dash-content::-webkit-scrollbar{width:6px;}
.dash-content::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px;}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:16px;transition:border-color .2s;cursor:default;animation:fadeUp .4s ease forwards;opacity:0;}
.stat-card:hover{border-color:var(--border2);}
.stat-card:nth-child(1){animation-delay:.05s;}
.stat-card:nth-child(2){animation-delay:.1s;}
.stat-card:nth-child(3){animation-delay:.15s;}
.stat-card:nth-child(4){animation-delay:.2s;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.sc-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.sc-icon{width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;}
.sc-val{font-size:28px;font-weight:700;color:var(--text);letter-spacing:-.5px;font-family:'Cormorant Garamond',serif;}
.sc-lbl{font-size:12px;color:var(--text2);margin-top:2px;}
.dash-grid{display:grid;grid-template-columns:1fr 340px;gap:14px;}
.dash-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;}
.dc-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.dc-title{font-size:14px;font-weight:600;color:var(--text);}
.dc-subtitle{font-size:11px;color:var(--text3);}
.dc-action{font-size:12px;color:var(--gold);cursor:pointer;text-decoration:none;}
.dc-action:hover{text-decoration:underline;}

/* pipeline */
.pipeline-cols{display:flex;gap:0;}
.pipeline-col{flex:1;border-right:1px solid var(--border);display:flex;flex-direction:column;}
.pipeline-col:last-child{border-right:none;}
.pc-header{padding:10px 12px;background:var(--bg3);border-bottom:1px solid var(--border);}
.pc-name{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.06em;}
.pc-count{font-size:10px;color:var(--text3);margin-top:1px;}
.pc-leads{padding:8px;display:flex;flex-direction:column;gap:6px;overflow-y:auto;max-height:200px;}
.pc-leads::-webkit-scrollbar{width:3px;}
.pc-leads::-webkit-scrollbar-thumb{background:var(--bg4);}
.lead-mini{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:8px;cursor:pointer;transition:all .15s;}
.lead-mini:hover{border-color:var(--border2);transform:translateY(-1px);}
.lm-name{font-size:12px;font-weight:600;color:var(--text);}
.lm-prop{font-size:11px;color:var(--text3);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.lm-budget{font-size:11px;color:var(--gold);font-weight:600;margin-top:4px;}

.activity-list{padding:10px 0;}
.act-item{display:flex;gap:12px;padding:10px 16px;border-bottom:1px solid var(--border);transition:background .15s;}
.act-item:last-child{border-bottom:none;}
.act-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:5px;}
.act-text{font-size:12px;color:var(--text2);line-height:1.5;}
.act-text strong{color:var(--text);}
.act-time{font-size:10px;color:var(--text3);margin-top:2px;}

.fu-dash-list{padding:8px 0;}
.fu-dash-item{display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;}
.fu-dash-item:hover{background:var(--bg3);}
.fu-dash-item:last-child{border-bottom:none;}
.fu-dash-av{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;background:var(--bg4);color:var(--text2);}
.fu-dash-info{flex:1;min-width:0;}
.fu-dash-name{font-size:13px;font-weight:600;color:var(--text);}
.fu-dash-note{font-size:11px;color:var(--text3);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.fu-dash-time{font-size:11px;font-weight:600;padding:3px 8px;border-radius:20px;flex-shrink:0;}
.fu-dash-time.urgent{background:var(--red-dim);color:var(--red);}
.fu-dash-time.today{background:var(--orange-dim);color:var(--orange);}
.fu-dash-time.upcoming{background:var(--blue-dim);color:var(--blue);}

/* ‚îÄ‚îÄ LEADS VIEW ‚îÄ‚îÄ */
.leads-content{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.leads-toolbar{padding:14px 24px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;}
.filter-chip{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:500;background:var(--bg3);border:1px solid var(--border);color:var(--text2);cursor:pointer;transition:all .15s;white-space:nowrap;}
.filter-chip:hover{border-color:var(--border2);color:var(--text);}
.filter-chip.active{background:var(--gold-dim);border-color:rgba(212,168,67,.3);color:var(--gold);}
.leads-table-wrap{flex:1;overflow-y:auto;padding:0 24px 20px;}
.leads-table-wrap::-webkit-scrollbar{width:6px;}
.leads-table-wrap::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px;}
table{width:100%;border-collapse:collapse;margin-top:14px;}
thead th{font-size:11px;font-weight:600;letter-spacing:.07em;text-transform:uppercase;color:var(--text3);padding:8px 12px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--border);transition:background .15s;cursor:pointer;}
tbody tr:hover{background:var(--bg2);}
tbody td{padding:12px 12px;font-size:13px;color:var(--text2);vertical-align:middle;}
.td-name{color:var(--text);font-weight:600;}
.td-phone{font-family:'JetBrains Mono',monospace;font-size:12px;}
.td-budget{color:var(--gold);font-weight:600;}
.td-actions{display:flex;gap:6px;}
.row-btn{height:26px;padding:0 10px;background:var(--bg3);border:1px solid var(--border);color:var(--text3);font-family:inherit;font-size:11px;border-radius:6px;cursor:pointer;transition:all .15s;white-space:nowrap;}
.row-btn:hover{border-color:var(--border2);color:var(--text);}
.row-btn.del:hover{border-color:rgba(224,85,85,.4);color:var(--red);}

/* ‚îÄ‚îÄ FOLLOW-UPS VIEW ‚îÄ‚îÄ */
.fu-content{flex:1;display:flex;overflow:hidden;}
.fu-sidebar{width:260px;border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;}
.fu-main-area{flex:1;overflow-y:auto;padding:20px 24px;}
.fu-main-area::-webkit-scrollbar{width:6px;}
.fu-main-area::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px;}
.fu-cal-header{padding:14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.fu-cal-title{font-size:13px;font-weight:600;}
.mini-cal{padding:12px;}
.mini-cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center;}
.mcg-day-name{font-size:9px;color:var(--text3);padding:2px 0;font-weight:600;}
.mcg-day{font-size:11px;padding:5px 3px;border-radius:5px;cursor:pointer;color:var(--text2);transition:all .15s;}
.mcg-day:hover{background:var(--bg3);color:var(--text);}
.mcg-day.today{background:var(--gold-dim);color:var(--gold);font-weight:700;}
.mcg-day.has-fu::after{content:'';display:block;width:4px;height:4px;background:var(--green);border-radius:50%;margin:2px auto 0;}
.fu-type-list{padding:10px;border-top:1px solid var(--border);}
.fu-type-item{display:flex;align-items:center;gap:8px;padding:7px 8px;border-radius:7px;cursor:pointer;transition:background .15s;font-size:12px;color:var(--text2);}
.fu-type-item:hover{background:var(--bg3);color:var(--text);}
.fu-type-item.active{background:var(--gold-dim);color:var(--gold);}
.fu-type-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.fu-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:12px;cursor:pointer;transition:all .2s;animation:fadeUp .3s ease forwards;opacity:0;}
.fu-card:hover{border-color:var(--border2);}
.fu-card-top{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
.fu-card-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0;background:var(--bg4);color:var(--text2);}
.fu-card-info{flex:1;min-width:0;}
.fu-card-name{font-size:14px;font-weight:600;color:var(--text);}
.fu-card-sub{font-size:12px;color:var(--text3);margin-top:1px;}
.fu-card-badges{display:flex;gap:6px;align-items:center;flex-shrink:0;}
.fu-body{background:var(--bg3);border-radius:7px;padding:10px;font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:10px;}
.fu-footer{display:flex;align-items:center;gap:8px;}
.fu-action-btn{flex:1;height:30px;border-radius:7px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-family:inherit;font-size:11px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;transition:all .15s;}
.fu-action-btn:hover{border-color:var(--border2);color:var(--text);}
.fu-action-btn.primary{background:var(--gold-dim);border-color:rgba(212,168,67,.3);color:var(--gold);}
.fu-action-btn.primary:hover{background:var(--gold-glow);}
.fu-action-btn.danger{background:var(--red-dim);border-color:rgba(224,85,85,.3);color:var(--red);}

/* ‚îÄ‚îÄ TAGS & BADGES ‚îÄ‚îÄ */
.tag{font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px;}
.tag-hot{background:var(--red-dim);color:var(--red);}
.tag-warm{background:var(--orange-dim);color:var(--orange);}
.tag-cold{background:var(--blue-dim);color:var(--blue);}
.tag-vip{background:var(--gold-dim);color:var(--gold);}
.tag-new{background:var(--green-dim);color:var(--green);}
.status-pill{display:inline-flex;align-items:center;gap:5px;font-size:10px;font-weight:600;padding:3px 8px;border-radius:20px;}
.pill-new{background:var(--green-dim);color:var(--green);border:1px solid rgba(76,175,125,.2);}
.pill-contacted{background:var(--blue-dim);color:var(--blue);border:1px solid rgba(107,163,214,.2);}
.pill-site{background:var(--orange-dim);color:var(--orange);border:1px solid rgba(232,146,74,.2);}
.pill-nego{background:var(--gold-dim);color:var(--gold);border:1px solid rgba(212,168,67,.2);}
.pill-closed{background:var(--green-dim);color:var(--green);border:1px solid rgba(76,175,125,.2);}
.pill-lost{background:rgba(90,80,69,.3);color:var(--text3);border:1px solid var(--border);}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:14px;width:520px;max-width:95vw;max-height:90vh;overflow-y:auto;animation:fadeUp .3s ease;}
.modal::-webkit-scrollbar{width:4px;}
.modal::-webkit-scrollbar-thumb{background:var(--bg4);}
.modal-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--bg2);z-index:1;}
.modal-header h3{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;}
.modal-close{width:30px;height:30px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text2);transition:all .15s;}
.modal-close:hover{border-color:var(--border2);color:var(--text);}
.modal-body{padding:20px;}
.form-row{margin-bottom:14px;}
.form-label{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;display:block;}
.form-input,.form-select,.form-textarea{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-family:inherit;font-size:13px;outline:none;transition:border-color .2s;}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:rgba(212,168,67,.4);}
.form-input::placeholder,.form-textarea::placeholder{color:var(--text3);}
.form-select option{background:var(--bg3);}
.form-textarea{resize:vertical;min-height:72px;line-height:1.5;}
.form-2col{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.modal-footer{padding:14px 20px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;}
.btn-cancel{padding:0 16px;height:34px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);font-family:inherit;font-size:13px;border-radius:8px;cursor:pointer;transition:all .15s;}
.btn-cancel:hover{border-color:var(--border2);color:var(--text);}
.btn-save{padding:0 20px;height:34px;background:var(--gold);border:none;color:#000;font-family:inherit;font-size:13px;font-weight:700;border-radius:8px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px;}
.btn-save:hover{background:var(--gold2);transform:translateY(-1px);}
.btn-save:disabled{opacity:.5;cursor:not-allowed;transform:none;}

/* ‚îÄ‚îÄ SETUP MODAL ‚îÄ‚îÄ */
.setup-modal{width:560px;}
.setup-step{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:12px;}
.setup-step-num{font-size:10px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px;}
.setup-step h4{font-size:14px;font-weight:600;margin-bottom:6px;}
.setup-step p{font-size:12px;color:var(--text2);line-height:1.6;}
.setup-step code{font-family:'JetBrains Mono',monospace;font-size:11px;background:var(--bg4);padding:2px 6px;border-radius:4px;color:var(--gold2);}

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;color:var(--text3);gap:12px;flex:1;}
.empty-state-icon{font-size:52px;opacity:.4;}
.empty-state h3{font-size:18px;font-weight:600;color:var(--text2);}
.empty-state p{font-size:13px;text-align:center;max-width:320px;line-height:1.6;}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
.loading{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--text3);gap:10px;font-size:13px;}
.spinner{width:18px;height:18px;border:2px solid var(--bg4);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0;}
@keyframes spin{to{transform:rotate(360deg);}}

/* ‚îÄ‚îÄ DB STATUS ‚îÄ‚îÄ */
.db-status{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text3);}
.db-dot{width:6px;height:6px;border-radius:50%;background:var(--text3);}
.db-dot.connected{background:var(--green);box-shadow:0 0 6px rgba(76,175,125,.5);}
.db-dot.error{background:var(--red);}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;bottom:24px;right:24px;background:var(--bg2);border:1px solid rgba(212,168,67,.3);border-radius:10px;padding:12px 16px;z-index:9999;display:flex;align-items:center;gap:10px;font-size:13px;color:var(--text);transform:translateY(20px);opacity:0;transition:all .3s;pointer-events:none;min-width:220px;box-shadow:0 8px 30px rgba(0,0,0,.5);}
.toast.show{transform:translateY(0);opacity:1;}
.toast.success{border-color:rgba(76,175,125,.3);}
.toast.error{border-color:rgba(224,85,85,.3);}

::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px;}
</style>
</head>
<body>

<!-- SETUP BANNER -->
<div class="setup-banner" id="setupBanner">
  ‚ö° Firebase not configured yet ‚Äî
  <a onclick="openSetupModal()">click here to connect your database</a>
  in 2 minutes (free)
  <span class="dismiss" onclick="document.getElementById('setupBanner').style.display='none'">‚úï</span>
</div>

<!-- TOPBAR -->
<div class="topbar">
  <div class="logo" onclick="setView('dashboard')">
    <div class="logo-icon">P</div>
    PropFlow
  </div>
  <div class="top-search">
    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="color:var(--text3)"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" id="globalSearch" placeholder="Search leads, follow-ups‚Ä¶" oninput="handleSearch(this.value)">
  </div>
  <div class="top-right">
    <div class="db-status" id="dbStatus">
      <div class="db-dot" id="dbDot"></div>
      <span id="dbStatusText">Not connected</span>
    </div>
    <div class="notif-btn" onclick="setView('followups')">
      <div class="notif-badge" id="todayFuBadge">0</div>
      <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
    </div>
    <button class="t-btn gold" onclick="openLeadModal()">
      <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Lead
    </button>
    <button class="t-btn" onclick="openSetupModal()">‚öô Config</button>
    <div class="avatar">RK</div>
  </div>
</div>

<!-- BODY -->
<div class="app-body">

<!-- SIDENAV -->
<nav class="sidenav">
  <div class="nav-section-label">Overview</div>
  <div class="nav-item active" id="nav-dashboard" onclick="setView('dashboard')">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
    Dashboard
  </div>
  <div class="nav-section-label">Work</div>
  <div class="nav-item" id="nav-leads" onclick="setView('leads')">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    Leads
    <span class="nav-badge hot" id="nav-leads-count">0</span>
  </div>
  <div class="nav-item" id="nav-followups" onclick="setView('followups')">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    Follow-ups
    <span class="nav-badge hot" id="nav-fu-count">0</span>
  </div>
  <div class="nav-divider"></div>
  <div class="nav-item" onclick="openSetupModal()">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    Setup Database
  </div>
  <div class="nav-spacer"></div>
  <div class="nav-agent-card">
    <div class="nac-top">
      <div class="nac-avatar">RK</div>
      <div><div class="nac-name">Your Name</div><div class="nac-role">Real Estate Agent</div></div>
    </div>
    <div class="nac-stats">
      <div class="nac-stat"><div class="nac-stat-val" id="stat-total">0</div><div class="nac-stat-lbl">Leads</div></div>
      <div class="nac-stat"><div class="nac-stat-val" id="stat-closed">0</div><div class="nac-stat-lbl">Closed</div></div>
      <div class="nac-stat"><div class="nac-stat-val" id="stat-hot">0</div><div class="nac-stat-lbl">Hot</div></div>
    </div>
  </div>
</nav>

<!-- MAIN -->
<div class="main">

<!-- ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê -->
<div class="view active" id="view-dashboard">
  <div class="page-header">
    <div class="page-title">
      <h1 id="dashGreeting">Good morning ‚òÄÔ∏è</h1>
      <p id="dashDate">Loading‚Ä¶</p>
    </div>
  </div>
  <div class="dash-content">
    <div class="stats-row">
      <div class="stat-card">
        <div class="sc-top">
          <div class="sc-icon" style="background:var(--gold-dim)">
            <svg width="18" height="18" fill="none" stroke="var(--gold)" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
          </div>
        </div>
        <div class="sc-val" id="dash-total">‚Äî</div>
        <div class="sc-lbl">Total Leads</div>
      </div>
      <div class="stat-card">
        <div class="sc-top">
          <div class="sc-icon" style="background:var(--red-dim)">
            <svg width="18" height="18" fill="none" stroke="var(--red)" stroke-width="2" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          </div>
        </div>
        <div class="sc-val" id="dash-hot">‚Äî</div>
        <div class="sc-lbl">Hot Leads</div>
      </div>
      <div class="stat-card">
        <div class="sc-top">
          <div class="sc-icon" style="background:var(--orange-dim)">
            <svg width="18" height="18" fill="none" stroke="var(--orange)" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          </div>
        </div>
        <div class="sc-val" id="dash-today-fu">‚Äî</div>
        <div class="sc-lbl">Follow-ups Today</div>
      </div>
      <div class="stat-card">
        <div class="sc-top">
          <div class="sc-icon" style="background:var(--green-dim)">
            <svg width="18" height="18" fill="none" stroke="var(--green)" stroke-width="2" viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
          </div>
        </div>
        <div class="sc-val" id="dash-closed">‚Äî</div>
        <div class="sc-lbl">Deals Closed</div>
      </div>
    </div>

    <div class="dash-grid">
      <!-- Pipeline -->
      <div class="dash-card">
        <div class="dc-header">
          <div><div class="dc-title">Lead Pipeline</div><div class="dc-subtitle">Live from database</div></div>
          <a class="dc-action" onclick="setView('leads')">View all ‚Üí</a>
        </div>
        <div class="pipeline-cols" style="min-height:200px" id="pipelineCols">
          <div class="pipeline-col">
            <div class="pc-header"><div class="pc-name" style="color:var(--blue)">New</div><div class="pc-count" id="pc-new">0 leads</div></div>
            <div class="pc-leads" id="pc-leads-new"><div class="loading"><div class="spinner"></div></div></div>
          </div>
          <div class="pipeline-col">
            <div class="pc-header"><div class="pc-name" style="color:var(--orange)">Site Visit</div><div class="pc-count" id="pc-site">0 leads</div></div>
            <div class="pc-leads" id="pc-leads-site"></div>
          </div>
          <div class="pipeline-col">
            <div class="pc-header"><div class="pc-name" style="color:var(--gold)">Negotiation</div><div class="pc-count" id="pc-nego">0 leads</div></div>
            <div class="pc-leads" id="pc-leads-nego"></div>
          </div>
          <div class="pipeline-col">
            <div class="pc-header"><div class="pc-name" style="color:var(--green)">Closed</div><div class="pc-count" id="pc-closed">0 leads</div></div>
            <div class="pc-leads" id="pc-leads-closed"></div>
          </div>
        </div>
      </div>

      <!-- Right column -->
      <div style="display:flex;flex-direction:column;gap:14px">
        <div class="dash-card">
          <div class="dc-header">
            <div><div class="dc-title">Today's Follow-ups</div><div class="dc-subtitle" id="dash-fu-subtitle">Loading‚Ä¶</div></div>
            <a class="dc-action" onclick="setView('followups')">See all ‚Üí</a>
          </div>
          <div id="dash-fu-list" class="fu-dash-list">
            <div class="loading"><div class="spinner"></div>Loading‚Ä¶</div>
          </div>
        </div>
        <div class="dash-card">
          <div class="dc-header"><div class="dc-title">Quick Add Lead</div></div>
          <div style="padding:14px">
            <div style="display:flex;gap:8px;margin-bottom:8px">
              <input class="form-input" style="flex:1" id="quick-name" placeholder="Full name">
              <input class="form-input" style="flex:1" id="quick-phone" placeholder="+91 phone">
            </div>
            <div style="display:flex;gap:8px">
              <input class="form-input" style="flex:1" id="quick-budget" placeholder="Budget (e.g. ‚Çπ1.5 Cr)">
              <button class="btn-save" style="flex-shrink:0" onclick="quickAddLead()">Add ‚Üí</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê LEADS VIEW ‚ïê‚ïê‚ïê -->
<div class="view" id="view-leads">
  <div class="page-header">
    <div class="page-title">
      <h1>Leads</h1>
      <p id="leads-subtitle">Loading from database‚Ä¶</p>
    </div>
    <div class="page-actions">
      <button class="t-btn gold" onclick="openLeadModal()">
        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Lead
      </button>
    </div>
  </div>
  <div class="leads-content">
    <div class="leads-toolbar" id="leadsToolbar">
      <div class="filter-chip active" data-filter="all">All (<span id="chip-all">0</span>)</div>
      <div class="filter-chip" data-filter="New">New (<span id="chip-new">0</span>)</div>
      <div class="filter-chip" data-filter="Contacted">Contacted (<span id="chip-contacted">0</span>)</div>
      <div class="filter-chip" data-filter="Site Visit">Site Visit (<span id="chip-site">0</span>)</div>
      <div class="filter-chip" data-filter="Negotiation">Negotiation (<span id="chip-nego">0</span>)</div>
      <div class="filter-chip" data-filter="Closed">Closed (<span id="chip-closed">0</span>)</div>
      <div class="filter-chip" data-filter="Lost">Lost (<span id="chip-lost">0</span>)</div>
    </div>
    <div class="leads-table-wrap">
      <table>
        <thead>
          <tr>
            <th>Name</th><th>Phone</th><th>Budget</th><th>Interest</th>
            <th>Source</th><th>Stage</th><th>Priority</th><th>Added</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="leadsTableBody">
          <tr><td colspan="9"><div class="loading"><div class="spinner"></div>Connecting to database‚Ä¶</div></td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê FOLLOW-UPS VIEW ‚ïê‚ïê‚ïê -->
<div class="view" id="view-followups">
  <div class="page-header">
    <div class="page-title">
      <h1>Follow-ups</h1>
      <p id="fu-subtitle">Loading‚Ä¶</p>
    </div>
    <div class="page-actions">
      <button class="t-btn gold" onclick="openFollowUpModal()">
        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Follow-up
      </button>
    </div>
  </div>
  <div class="fu-content">
    <div class="fu-sidebar">
      <div class="fu-cal-header">
        <span class="fu-cal-title" id="calMonth">February 2026</span>
      </div>
      <div class="mini-cal" id="miniCal"></div>
      <div class="fu-type-list">
        <div class="fu-type-item active" data-type="all">
          <div class="fu-type-dot" style="background:var(--gold)"></div> All Follow-ups
        </div>
        <div class="fu-type-item" data-type="Call">
          <div class="fu-type-dot" style="background:var(--blue)"></div> Calls
        </div>
        <div class="fu-type-item" data-type="WhatsApp">
          <div class="fu-type-dot" style="background:var(--green)"></div> WhatsApp
        </div>
        <div class="fu-type-item" data-type="Site Visit">
          <div class="fu-type-dot" style="background:var(--orange)"></div> Site Visits
        </div>
        <div class="fu-type-item" data-type="Document">
          <div class="fu-type-dot" style="background:var(--red)"></div> Documents
        </div>
      </div>
    </div>
    <div class="fu-main-area" id="fuMainArea">
      <div class="loading"><div class="spinner"></div>Loading follow-ups‚Ä¶</div>
    </div>
  </div>
</div>

</div><!-- end main -->
</div><!-- end app-body -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADD LEAD MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="leadModalOverlay" onclick="if(event.target===this)closeLeadModal()">
  <div class="modal">
    <div class="modal-header">
      <h3 id="leadModalTitle">Add New Lead</h3>
      <div class="modal-close" onclick="closeLeadModal()">‚úï</div>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editLeadId">
      <div class="form-2col">
        <div class="form-row"><label class="form-label">Full Name *</label><input class="form-input" id="f-name" placeholder="e.g. Arjun Sharma"></div>
        <div class="form-row"><label class="form-label">Phone *</label><input class="form-input" id="f-phone" placeholder="+91 98800 12345"></div>
      </div>
      <div class="form-2col">
        <div class="form-row"><label class="form-label">Email</label><input class="form-input" id="f-email" placeholder="arjun@email.com"></div>
        <div class="form-row"><label class="form-label">Budget</label><input class="form-input" id="f-budget" placeholder="‚Çπ 1.5 Cr"></div>
      </div>
      <div class="form-2col">
        <div class="form-row"><label class="form-label">Property Type</label>
          <select class="form-select" id="f-proptype">
            <option value="">Select type</option>
            <option>1BHK Apartment</option><option>2BHK Apartment</option><option>3BHK Apartment</option>
            <option>4BHK Apartment</option><option>Villa</option><option>Studio</option>
            <option>Commercial</option><option>Plot</option><option>Penthouse</option>
          </select>
        </div>
        <div class="form-row"><label class="form-label">Preferred Location</label><input class="form-input" id="f-location" placeholder="Andheri East, Mumbai"></div>
      </div>
      <div class="form-2col">
        <div class="form-row"><label class="form-label">Lead Source</label>
          <select class="form-select" id="f-source">
            <option value="">Select source</option>
            <option>99acres</option><option>Housing.com</option><option>MagicBricks</option>
            <option>Instagram Ad</option><option>Facebook Ad</option><option>Google Ad</option>
            <option>Referral</option><option>Website</option><option>Walk-in</option><option>Cold Call</option>
          </select>
        </div>
        <div class="form-row"><label class="form-label">Pipeline Stage</label>
          <select class="form-select" id="f-stage">
            <option value="New">New</option><option value="Contacted">Contacted</option>
            <option value="Site Visit">Site Visit</option><option value="Negotiation">Negotiation</option>
            <option value="Closed">Closed</option><option value="Lost">Lost</option>
          </select>
        </div>
      </div>
      <div class="form-2col">
        <div class="form-row"><label class="form-label">Priority</label>
          <select class="form-select" id="f-priority">
            <option value="Normal">Normal</option><option value="Hot">üî• Hot</option>
            <option value="Warm">Warm</option><option value="Cold">Cold</option><option value="VIP">‚≠ê VIP</option>
          </select>
        </div>
        <div class="form-row"><label class="form-label">WhatsApp Number</label><input class="form-input" id="f-wa" placeholder="Same as phone if same"></div>
      </div>
      <div class="form-row"><label class="form-label">Notes</label><textarea class="form-textarea" id="f-notes" placeholder="Key preferences, requirements, special notes‚Ä¶"></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeLeadModal()">Cancel</button>
      <button class="btn-save" id="saveLeadBtn" onclick="saveLead()">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
        Save Lead
      </button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADD FOLLOW-UP MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="fuModalOverlay" onclick="if(event.target===this)closeFuModal()">
  <div class="modal">
    <div class="modal-header">
      <h3 id="fuModalTitle">Add Follow-up</h3>
      <div class="modal-close" onclick="closeFuModal()">‚úï</div>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editFuId">
      <div class="form-2col">
        <div class="form-row"><label class="form-label">Lead Name *</label>
          <select class="form-select" id="fu-leadId">
            <option value="">Select a lead</option>
          </select>
        </div>
        <div class="form-row"><label class="form-label">Follow-up Type *</label>
          <select class="form-select" id="fu-type">
            <option value="Call">üìû Call</option>
            <option value="WhatsApp">üí¨ WhatsApp</option>
            <option value="Site Visit">üè† Site Visit</option>
            <option value="Document">üìÑ Send Document</option>
            <option value="Email">üìß Email</option>
            <option value="Meeting">ü§ù Meeting</option>
          </select>
        </div>
      </div>
      <div class="form-2col">
        <div class="form-row"><label class="form-label">Date *</label><input class="form-input" id="fu-date" type="date"></div>
        <div class="form-row"><label class="form-label">Time</label><input class="form-input" id="fu-time" type="time" value="10:00"></div>
      </div>
      <div class="form-row"><label class="form-label">Priority</label>
        <select class="form-select" id="fu-priority">
          <option value="Normal">Normal</option>
          <option value="Urgent">üî¥ Urgent</option>
          <option value="High">High</option>
        </select>
      </div>
      <div class="form-row"><label class="form-label">Notes / Reminder *</label>
        <textarea class="form-textarea" id="fu-notes" placeholder="What do you need to do in this follow-up? Be specific‚Ä¶"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeFuModal()">Cancel</button>
      <button class="btn-save" id="saveFuBtn" onclick="saveFollowUp()">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
        Save Follow-up
      </button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETUP MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="setupModalOverlay" onclick="if(event.target===this)closeSetupModal()">
  <div class="modal setup-modal">
    <div class="modal-header">
      <h3>üî• Connect Firebase Database</h3>
      <div class="modal-close" onclick="closeSetupModal()">‚úï</div>
    </div>
    <div class="modal-body">
      <div class="setup-step">
        <div class="setup-step-num">Step 1</div>
        <h4>Create a Firebase project (free)</h4>
        <p>Go to <strong>console.firebase.google.com</strong> ‚Üí Click <code>Add project</code> ‚Üí Name it <code>propflow-crm</code> ‚Üí Continue (disable Google Analytics if you want) ‚Üí Create project.</p>
      </div>
      <div class="setup-step">
        <div class="setup-step-num">Step 2</div>
        <h4>Add a Web App & get config</h4>
        <p>In your project ‚Üí Click <code>&lt;/&gt;</code> (Web) icon ‚Üí Register app ‚Üí Copy the <code>firebaseConfig</code> object that appears.</p>
      </div>
      <div class="setup-step">
        <div class="setup-step-num">Step 3</div>
        <h4>Enable Firestore Database</h4>
        <p>In left sidebar ‚Üí <code>Build</code> ‚Üí <code>Firestore Database</code> ‚Üí <code>Create database</code> ‚Üí Choose <code>Start in test mode</code> ‚Üí Select a region ‚Üí Done.</p>
      </div>
      <div class="setup-step">
        <div class="setup-step-num">Step 4 ‚Äî Paste your config below</div>
        <h4>Enter your Firebase config values</h4>
        <p style="margin-bottom:12px">Paste the values from your <code>firebaseConfig</code> object:</p>
        <div class="form-row"><label class="form-label">API Key</label><input class="form-input" id="cfg-apiKey" placeholder="AIzaSy‚Ä¶"></div>
        <div class="form-2col">
          <div class="form-row"><label class="form-label">Auth Domain</label><input class="form-input" id="cfg-authDomain" placeholder="your-project.firebaseapp.com"></div>
          <div class="form-row"><label class="form-label">Project ID</label><input class="form-input" id="cfg-projectId" placeholder="your-project-id"></div>
        </div>
        <div class="form-2col">
          <div class="form-row"><label class="form-label">Storage Bucket</label><input class="form-input" id="cfg-storageBucket" placeholder="your-project.appspot.com"></div>
          <div class="form-row"><label class="form-label">Messaging Sender ID</label><input class="form-input" id="cfg-messagingSenderId" placeholder="123456789"></div>
        </div>
        <div class="form-row"><label class="form-label">App ID</label><input class="form-input" id="cfg-appId" placeholder="1:123456:web:abc123‚Ä¶"></div>
      </div>
      <div style="background:var(--gold-dim);border:1px solid rgba(212,168,67,.3);border-radius:8px;padding:12px;font-size:12px;color:var(--gold2)">
        ‚ö° After saving, the page will reload with your database connected. Your leads and follow-ups will persist forever in Firestore ‚Äî free up to 50,000 reads/day.
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeSetupModal()">Cancel</button>
      <button class="btn-save" onclick="saveFirebaseConfig()">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
        Save & Connect
      </button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <span id="toastIcon">‚ú®</span>
  <span id="toastMsg">Done!</span>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _leads = [];
let _followups = [];
let _currentFilter = 'all';
let _currentFuType = 'all';
let _editingLeadId = null;
let _editingFuId = null;
let _dbConnected = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE CONFIG ‚Äî saved to localStorage
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getSavedConfig() {
  try { return JSON.parse(localStorage.getItem('pfConfig') || 'null'); } catch { return null; }
}

function initApp() {
  const cfg = getSavedConfig();
  updateDate();
  buildMiniCal();

  // If no config saved, show demo mode
  if (!cfg || !cfg.projectId || cfg.projectId === 'YOUR_PROJECT_ID') {
    setDbStatus(false, 'Demo mode');
    document.getElementById('setupBanner').style.display = 'flex';
    useDemoMode();
    return;
  }

  // Config exists ‚Äî try to reinitialize Firebase with saved config
  loadSavedConfig(cfg);
}

function loadSavedConfig(cfg) {
  // Reinitialize Firebase with saved config
  try {
    // Dynamic import with saved config
    const scriptTag = document.createElement('script');
    scriptTag.type = 'module';
    scriptTag.textContent = `
      import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
      const cfg = ${JSON.stringify(cfg)};
      const existing = getApps();
      const app = existing.length ? existing[0] : initializeApp(cfg);
      const db = getFirestore(app);
      window._db = db;
      window._firebase = { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot, serverTimestamp };
      window._dbReady = true;
      window.dispatchEvent(new Event('dbReady'));
    `;
    document.head.appendChild(scriptTag);

    window.addEventListener('dbReady', () => {
      setDbStatus(true, 'Connected');
      document.getElementById('setupBanner').style.display = 'none';
      _dbConnected = true;
      loadLeadsFromDB();
      loadFollowUpsFromDB();
    }, { once: true });

    // Timeout fallback
    setTimeout(() => {
      if (!_dbConnected) {
        setDbStatus(false, 'Connection failed');
        showToast('‚ö†Ô∏è Could not connect. Check your Firebase config.', 'error');
        useDemoMode();
      }
    }, 8000);

  } catch(e) {
    setDbStatus(false, 'Config error');
    useDemoMode();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEMO MODE (no Firebase)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function useDemoMode() {
  _leads = [];
  _followups = [];
  renderLeads();
  renderFollowUps();
  renderDashboard();
  showToast('üí° Demo mode ‚Äî connect Firebase to save data permanently', 'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIRESTORE CRUD ‚Äî LEADS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadLeadsFromDB() {
  try {
    const { collection, onSnapshot, orderBy, query } = window._firebase;
    const db = window._db;
    const q = query(collection(db, 'leads'), orderBy('createdAt', 'desc'));
    onSnapshot(q, (snapshot) => {
      _leads = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      renderLeads();
      renderDashboard();
      updateNavCounts();
    }, (err) => {
      console.error('Leads listener error:', err);
      setDbStatus(false, 'Read error');
    });
  } catch(e) {
    showToast('‚ùå Could not load leads: ' + e.message, 'error');
  }
}

async function addLeadToDB(data) {
  const { collection, addDoc, serverTimestamp } = window._firebase;
  const db = window._db;
  await addDoc(collection(db, 'leads'), { ...data, createdAt: serverTimestamp() });
}

async function updateLeadInDB(id, data) {
  const { doc, updateDoc } = window._firebase;
  const db = window._db;
  await updateDoc(doc(db, 'leads', id), data);
}

async function deleteLeadFromDB(id) {
  const { doc, deleteDoc } = window._firebase;
  const db = window._db;
  await deleteDoc(doc(db, 'leads', id));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIRESTORE CRUD ‚Äî FOLLOW-UPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadFollowUpsFromDB() {
  try {
    const { collection, onSnapshot, orderBy, query } = window._firebase;
    const db = window._db;
    const q = query(collection(db, 'followups'), orderBy('date', 'asc'));
    onSnapshot(q, (snapshot) => {
      _followups = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      renderFollowUps();
      renderDashboard();
      updateNavCounts();
    });
  } catch(e) {
    showToast('‚ùå Could not load follow-ups: ' + e.message, 'error');
  }
}

async function addFollowUpToDB(data) {
  const { collection, addDoc, serverTimestamp } = window._firebase;
  const db = window._db;
  await addDoc(collection(db, 'followups'), { ...data, createdAt: serverTimestamp() });
}

async function updateFollowUpInDB(id, data) {
  const { doc, updateDoc } = window._firebase;
  const db = window._db;
  await updateDoc(doc(db, 'followups', id), data);
}

async function deleteFollowUpFromDB(id) {
  const { doc, deleteDoc } = window._firebase;
  const db = window._db;
  await deleteDoc(doc(db, 'followups', id));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ‚Äî LEADS TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLeads(filter) {
  if (filter !== undefined) _currentFilter = filter;
  const tbody = document.getElementById('leadsTableBody');
  let list = _leads;
  if (_currentFilter !== 'all') list = list.filter(l => l.stage === _currentFilter);

  // Update chip counts
  const counts = {};
  _leads.forEach(l => { counts[l.stage] = (counts[l.stage] || 0) + 1; });
  document.getElementById('chip-all').textContent = _leads.length;
  ['new','contacted','site','nego','closed','lost'].forEach((k, i) => {
    const stages = ['New','Contacted','Site Visit','Negotiation','Closed','Lost'];
    const el = document.getElementById('chip-' + k);
    if(el) el.textContent = counts[stages[i]] || 0;
  });

  document.getElementById('leads-subtitle').textContent =
    `${_leads.length} total leads ¬∑ ${counts['New']||0} new ¬∑ ${counts['Negotiation']||0} in negotiation`;

  if (list.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9">
      <div class="empty-state">
        <div class="empty-state-icon">üë•</div>
        <h3>${_currentFilter==='all' ? 'No leads yet' : 'No '+_currentFilter+' leads'}</h3>
        <p>${_currentFilter==='all' ? 'Click "Add Lead" to add your first lead and start tracking.' : 'No leads in this stage yet.'}</p>
      </div>
    </td></tr>`;
    return;
  }

  tbody.innerHTML = list.map(l => {
    const pillClass = {
      'New':'pill-new','Contacted':'pill-contacted','Site Visit':'pill-site',
      'Negotiation':'pill-nego','Closed':'pill-closed','Lost':'pill-lost'
    }[l.stage] || 'pill-new';
    const priorityBadge = l.priority === 'Hot' ? '<span class="tag tag-hot">üî• Hot</span>' :
      l.priority === 'VIP' ? '<span class="tag tag-vip">‚≠ê VIP</span>' :
      l.priority === 'Warm' ? '<span class="tag tag-warm">Warm</span>' :
      l.priority === 'Cold' ? '<span class="tag tag-cold">Cold</span>' : '‚Äî';
    const date = l.createdAt?.toDate ? l.createdAt.toDate().toLocaleDateString('en-IN',{day:'2-digit',month:'short'}) : 'Just now';
    return `<tr>
      <td><span class="td-name">${esc(l.name)}</span></td>
      <td><span class="td-phone">${esc(l.phone||'‚Äî')}</span></td>
      <td><span class="td-budget">${esc(l.budget||'‚Äî')}</span></td>
      <td>${esc(l.location||'‚Äî')}</td>
      <td>${esc(l.source||'‚Äî')}</td>
      <td><span class="status-pill ${pillClass}">${l.stage}</span></td>
      <td>${priorityBadge}</td>
      <td style="font-size:11px;color:var(--text3)">${date}</td>
      <td>
        <div class="td-actions">
          <button class="row-btn" onclick="openLeadModal('${l.id}')">‚úèÔ∏è Edit</button>
          <button class="row-btn" onclick="openFollowUpModal(null,'${l.id}')">üìÖ FU</button>
          <button class="row-btn del" onclick="confirmDeleteLead('${l.id}','${esc(l.name)}')">üóë</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ‚Äî FOLLOW-UPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFollowUps(type) {
  if (type !== undefined) _currentFuType = type;
  const container = document.getElementById('fuMainArea');
  const today = new Date().toISOString().split('T')[0];

  let list = _followups.filter(f => f.status !== 'done');
  if (_currentFuType !== 'all') list = list.filter(f => f.type === _currentFuType);

  document.getElementById('fu-subtitle').textContent =
    `${list.filter(f => f.date === today).length} due today ¬∑ ${list.length} pending total`;

  if (list.length === 0) {
    container.innerHTML = `<div class="empty-state">
      <div class="empty-state-icon">üìÖ</div>
      <h3>No follow-ups yet</h3>
      <p>Add a follow-up reminder for a lead to get started. Stay on top of every client.</p>
      <button class="btn-save" onclick="openFollowUpModal()">+ Add Follow-up</button>
    </div>`;
    return;
  }

  // Group by date
  const groups = {};
  list.forEach(f => {
    const d = f.date || 'No date';
    if (!groups[d]) groups[d] = [];
    groups[d].push(f);
  });
  const sortedDates = Object.keys(groups).sort();

  container.innerHTML = sortedDates.map(date => {
    const label = date === today ? 'üî¥ Today ‚Äî ' + formatDate(date) :
      date < today ? '‚ö†Ô∏è Overdue ‚Äî ' + formatDate(date) :
      formatDate(date);
    const cards = groups[date].map((f, i) => renderFuCard(f, i)).join('');
    return `<div style="font-size:12px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin:${date===sortedDates[0]?'0':'16px'} 0 12px">${label}</div>${cards}`;
  }).join('');
}

function renderFuCard(f, idx) {
  const lead = _leads.find(l => l.id === f.leadId);
  const leadName = lead ? lead.name : (f.leadName || 'Unknown Lead');
  const initials = leadName.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
  const typeIcon = {Call:'üìû',WhatsApp:'üí¨','Site Visit':'üè†',Document:'üìÑ',Email:'üìß',Meeting:'ü§ù'}[f.type] || 'üìã';
  const urgentClass = f.priority === 'Urgent' ? 'tag-hot' : f.priority === 'High' ? 'tag-warm' : '';
  const timeDisplay = f.time || '';
  const timeStyle = f.priority === 'Urgent' ? 'background:var(--red-dim);color:var(--red)' : 'background:var(--orange-dim);color:var(--orange)';

  return `<div class="fu-card" style="animation-delay:${idx * 0.05}s">
    <div class="fu-card-top">
      <div class="fu-card-avatar">${initials}</div>
      <div class="fu-card-info">
        <div class="fu-card-name">${esc(leadName)}</div>
        <div class="fu-card-sub">${lead ? esc(lead.budget||'') + (lead.location ? ' ¬∑ '+lead.location : '') : 'Lead details not found'}</div>
      </div>
      <div class="fu-card-badges">
        ${urgentClass ? `<span class="tag ${urgentClass}">${f.priority}</span>` : ''}
        ${timeDisplay ? `<span style="font-size:11px;font-weight:600;padding:3px 8px;border-radius:20px;${timeStyle}">${timeDisplay}</span>` : ''}
      </div>
    </div>
    <div class="fu-body">${typeIcon} <strong>${f.type}</strong> ‚Äî ${esc(f.notes||'No notes')}</div>
    <div class="fu-footer">
      <button class="fu-action-btn primary" onclick="markFuDone('${f.id}')">‚úì Done</button>
      <button class="fu-action-btn" onclick="openFollowUpModal('${f.id}')">‚úèÔ∏è Edit</button>
      <button class="fu-action-btn danger" onclick="confirmDeleteFu('${f.id}')">üóë Delete</button>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ‚Äî DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard() {
  const today = new Date().toISOString().split('T')[0];
  const hot = _leads.filter(l => l.priority === 'Hot' || l.priority === 'VIP').length;
  const closed = _leads.filter(l => l.stage === 'Closed').length;
  const todayFu = _followups.filter(f => f.date === today && f.status !== 'done').length;

  document.getElementById('dash-total').textContent = _leads.length;
  document.getElementById('dash-hot').textContent = hot;
  document.getElementById('dash-today-fu').textContent = todayFu;
  document.getElementById('dash-closed').textContent = closed;
  document.getElementById('stat-total').textContent = _leads.length;
  document.getElementById('stat-closed').textContent = closed;
  document.getElementById('stat-hot').textContent = hot;

  // Notification badge
  document.getElementById('todayFuBadge').textContent = todayFu;

  // Pipeline
  const stages = ['New','Site Visit','Negotiation','Closed'];
  const stageKeys = ['new','site','nego','closed'];
  stages.forEach((s, i) => {
    const filtered = _leads.filter(l => l.stage === s);
    const key = stageKeys[i];
    const countEl = document.getElementById('pc-' + key);
    if(countEl) countEl.textContent = filtered.length + ' lead' + (filtered.length!==1?'s':'');
    const listEl = document.getElementById('pc-leads-' + key);
    if(listEl) {
      if(filtered.length === 0) {
        listEl.innerHTML = `<div style="font-size:11px;color:var(--text3);padding:8px;text-align:center">No leads</div>`;
      } else {
        listEl.innerHTML = filtered.slice(0,4).map(l => `
          <div class="lead-mini" onclick="setView('leads')">
            <div class="lm-name">${esc(l.name)}</div>
            <div class="lm-prop">${esc(l.location||'')}</div>
            <div class="lm-budget">${esc(l.budget||'‚Äî')}</div>
          </div>`).join('');
      }
    }
  });

  // Today's follow-ups in dashboard
  const todayList = _followups.filter(f => f.date === today && f.status !== 'done');
  const dashFuList = document.getElementById('dash-fu-list');
  document.getElementById('dash-fu-subtitle').textContent = todayFu + ' pending today';

  if (todayList.length === 0) {
    dashFuList.innerHTML = `<div style="padding:16px;text-align:center;font-size:12px;color:var(--text3)">üéâ No follow-ups due today!</div>`;
  } else {
    dashFuList.innerHTML = todayList.slice(0,4).map(f => {
      const lead = _leads.find(l => l.id === f.leadId);
      const name = lead ? lead.name : (f.leadName || 'Unknown');
      const initials = name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
      return `<div class="fu-dash-item" onclick="setView('followups')">
        <div class="fu-dash-av">${initials}</div>
        <div class="fu-dash-info">
          <div class="fu-dash-name">${esc(name)}</div>
          <div class="fu-dash-note">${f.type}: ${esc(f.notes||'')}</div>
        </div>
        <span class="fu-dash-time ${f.priority==='Urgent'?'urgent':'today'}">${f.time||'Today'}</span>
      </div>`;
    }).join('');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE / ADD LEAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveLead() {
  const name = document.getElementById('f-name').value.trim();
  const phone = document.getElementById('f-phone').value.trim();
  if (!name || !phone) { showToast('‚ö†Ô∏è Name and phone are required', 'error'); return; }

  const data = {
    name, phone,
    email: document.getElementById('f-email').value.trim(),
    budget: document.getElementById('f-budget').value.trim(),
    proptype: document.getElementById('f-proptype').value,
    location: document.getElementById('f-location').value.trim(),
    source: document.getElementById('f-source').value,
    stage: document.getElementById('f-stage').value || 'New',
    priority: document.getElementById('f-priority').value || 'Normal',
    wa: document.getElementById('f-wa').value.trim(),
    notes: document.getElementById('f-notes').value.trim(),
  };

  const btn = document.getElementById('saveLeadBtn');
  btn.disabled = true; btn.textContent = 'Saving‚Ä¶';

  try {
    if (_editingLeadId) {
      if (_dbConnected) await updateLeadInDB(_editingLeadId, data);
      else { const idx = _leads.findIndex(l=>l.id===_editingLeadId); if(idx>-1) _leads[idx]={..._leads[idx],...data}; renderLeads(); renderDashboard(); }
      showToast('‚úÖ Lead updated!', 'success');
    } else {
      if (_dbConnected) await addLeadToDB(data);
      else { _leads.unshift({id:'demo-'+Date.now(),...data,createdAt:null}); renderLeads(); renderDashboard(); }
      showToast('‚úÖ Lead saved to database!', 'success');
    }
    closeLeadModal();
  } catch(e) {
    showToast('‚ùå Error saving: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg> Save Lead';
  }
}

async function quickAddLead() {
  const name = document.getElementById('quick-name').value.trim();
  const phone = document.getElementById('quick-phone').value.trim();
  const budget = document.getElementById('quick-budget').value.trim();
  if (!name || !phone) { showToast('‚ö†Ô∏è Name and phone required', 'error'); return; }

  try {
    const data = { name, phone, budget, stage:'New', priority:'Normal', email:'', location:'', source:'', notes:'' };
    if (_dbConnected) await addLeadToDB(data);
    else { _leads.unshift({id:'demo-'+Date.now(),...data,createdAt:null}); renderLeads(); renderDashboard(); }
    document.getElementById('quick-name').value = '';
    document.getElementById('quick-phone').value = '';
    document.getElementById('quick-budget').value = '';
    showToast('‚úÖ Lead added!', 'success');
  } catch(e) {
    showToast('‚ùå Error: ' + e.message, 'error');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE / ADD FOLLOW-UP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveFollowUp() {
  const leadId = document.getElementById('fu-leadId').value;
  const date = document.getElementById('fu-date').value;
  const notes = document.getElementById('fu-notes').value.trim();
  if (!leadId) { showToast('‚ö†Ô∏è Please select a lead', 'error'); return; }
  if (!date) { showToast('‚ö†Ô∏è Please select a date', 'error'); return; }
  if (!notes) { showToast('‚ö†Ô∏è Please add a note/reminder', 'error'); return; }

  const lead = _leads.find(l => l.id === leadId);
  const data = {
    leadId,
    leadName: lead ? lead.name : '',
    type: document.getElementById('fu-type').value,
    date,
    time: document.getElementById('fu-time').value,
    priority: document.getElementById('fu-priority').value,
    notes,
    status: 'pending'
  };

  const btn = document.getElementById('saveFuBtn');
  btn.disabled = true; btn.textContent = 'Saving‚Ä¶';

  try {
    if (_editingFuId) {
      if (_dbConnected) await updateFollowUpInDB(_editingFuId, data);
      else { const idx = _followups.findIndex(f=>f.id===_editingFuId); if(idx>-1) _followups[idx]={..._followups[idx],...data}; }
      showToast('‚úÖ Follow-up updated!', 'success');
    } else {
      if (_dbConnected) await addFollowUpToDB(data);
      else { _followups.push({id:'demo-fu-'+Date.now(),...data}); }
      showToast('‚úÖ Follow-up scheduled!', 'success');
    }
    renderFollowUps();
    renderDashboard();
    closeFuModal();
  } catch(e) {
    showToast('‚ùå Error: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg> Save Follow-up';
  }
}

async function markFuDone(id) {
  try {
    if (_dbConnected) await updateFollowUpInDB(id, { status: 'done' });
    else { const f = _followups.find(f=>f.id===id); if(f) f.status='done'; }
    renderFollowUps(); renderDashboard();
    showToast('‚úÖ Marked as done!', 'success');
  } catch(e) { showToast('‚ùå Error: ' + e.message, 'error'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DELETE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function confirmDeleteLead(id, name) {
  if (!confirm(`Delete lead "${name}"? This cannot be undone.`)) return;
  deleteLead(id, name);
}
async function deleteLead(id, name) {
  try {
    if (_dbConnected) await deleteLeadFromDB(id);
    else { _leads = _leads.filter(l => l.id !== id); renderLeads(); renderDashboard(); }
    showToast(`üóë ${name} deleted`, 'success');
  } catch(e) { showToast('‚ùå Error: ' + e.message, 'error'); }
}

function confirmDeleteFu(id) {
  if (!confirm('Delete this follow-up?')) return;
  deleteFu(id);
}
async function deleteFu(id) {
  try {
    if (_dbConnected) await deleteFollowUpFromDB(id);
    else { _followups = _followups.filter(f => f.id !== id); renderFollowUps(); renderDashboard(); }
    showToast('üóë Follow-up deleted', 'success');
  } catch(e) { showToast('‚ùå Error: ' + e.message, 'error'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openLeadModal(leadId) {
  _editingLeadId = leadId || null;
  document.getElementById('leadModalTitle').textContent = leadId ? 'Edit Lead' : 'Add New Lead';
  const fields = ['name','phone','email','budget','proptype','location','source','stage','priority','wa','notes'];
  fields.forEach(f => { const el = document.getElementById('f-'+f); if(el) el.value = ''; });

  if (leadId) {
    const lead = _leads.find(l => l.id === leadId);
    if (lead) {
      fields.forEach(f => {
        const el = document.getElementById('f-'+f);
        if (el && lead[f] !== undefined) el.value = lead[f];
      });
    }
  }
  document.getElementById('leadModalOverlay').classList.add('open');
}
function closeLeadModal() {
  document.getElementById('leadModalOverlay').classList.remove('open');
  _editingLeadId = null;
}

function openFollowUpModal(fuId, presetLeadId) {
  _editingFuId = fuId || null;
  document.getElementById('fuModalTitle').textContent = fuId ? 'Edit Follow-up' : 'Add Follow-up';

  // Populate lead dropdown
  const sel = document.getElementById('fu-leadId');
  sel.innerHTML = '<option value="">Select a lead</option>' +
    _leads.map(l => `<option value="${l.id}">${esc(l.name)} ${l.phone?'('+l.phone+')':''}</option>`).join('');

  // Reset fields
  ['fu-leadId','fu-type','fu-date','fu-time','fu-priority','fu-notes'].forEach(id => {
    const el = document.getElementById(id);
    if (el && id !== 'fu-type' && id !== 'fu-priority') el.value = '';
  });
  document.getElementById('fu-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('fu-time').value = '10:00';

  if (presetLeadId) document.getElementById('fu-leadId').value = presetLeadId;

  if (fuId) {
    const fu = _followups.find(f => f.id === fuId);
    if (fu) {
      document.getElementById('fu-leadId').value = fu.leadId || '';
      document.getElementById('fu-type').value = fu.type || 'Call';
      document.getElementById('fu-date').value = fu.date || '';
      document.getElementById('fu-time').value = fu.time || '10:00';
      document.getElementById('fu-priority').value = fu.priority || 'Normal';
      document.getElementById('fu-notes').value = fu.notes || '';
    }
  }
  document.getElementById('fuModalOverlay').classList.add('open');
}
function closeFuModal() {
  document.getElementById('fuModalOverlay').classList.remove('open');
  _editingFuId = null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE CONFIG SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSetupModal() {
  const cfg = getSavedConfig();
  if (cfg) {
    ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'].forEach(k => {
      const el = document.getElementById('cfg-'+k);
      if (el && cfg[k]) el.value = cfg[k];
    });
  }
  document.getElementById('setupModalOverlay').classList.add('open');
}
function closeSetupModal() {
  document.getElementById('setupModalOverlay').classList.remove('open');
}
function saveFirebaseConfig() {
  const cfg = {
    apiKey: document.getElementById('cfg-apiKey').value.trim(),
    authDomain: document.getElementById('cfg-authDomain').value.trim(),
    projectId: document.getElementById('cfg-projectId').value.trim(),
    storageBucket: document.getElementById('cfg-storageBucket').value.trim(),
    messagingSenderId: document.getElementById('cfg-messagingSenderId').value.trim(),
    appId: document.getElementById('cfg-appId').value.trim()
  };
  if (!cfg.apiKey || !cfg.projectId) {
    showToast('‚ö†Ô∏è API Key and Project ID are required', 'error');
    return;
  }
  localStorage.setItem('pfConfig', JSON.stringify(cfg));
  showToast('‚úÖ Config saved! Reloading‚Ä¶', 'success');
  setTimeout(() => location.reload(), 1500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleSearch(val) {
  if (!val.trim()) { renderLeads(); return; }
  const q = val.toLowerCase();
  const filtered = _leads.filter(l =>
    (l.name||'').toLowerCase().includes(q) ||
    (l.phone||'').includes(q) ||
    (l.location||'').toLowerCase().includes(q) ||
    (l.budget||'').toLowerCase().includes(q)
  );
  const tbody = document.getElementById('leadsTableBody');
  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:30px;color:var(--text3)">No leads found for "${val}"</td></tr>`;
    return;
  }
  // Temporarily set leads and re-render
  const orig = _leads;
  _leads = filtered;
  renderLeads();
  _leads = orig;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');
  const ni = document.getElementById('nav-' + name);
  if (ni) ni.classList.add('active');
}

function updateNavCounts() {
  const hot = _leads.filter(l => l.priority === 'Hot' || l.priority === 'VIP').length;
  const today = new Date().toISOString().split('T')[0];
  const todayFu = _followups.filter(f => f.date === today && f.status !== 'done').length;
  document.getElementById('nav-leads-count').textContent = hot > 0 ? hot + ' hot' : _leads.length;
  document.getElementById('nav-fu-count').textContent = todayFu;
  document.getElementById('todayFuBadge').textContent = todayFu;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTER CHIPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('leadsToolbar').addEventListener('click', e => {
  const chip = e.target.closest('.filter-chip');
  if (!chip) return;
  document.querySelectorAll('#leadsToolbar .filter-chip').forEach(c => c.classList.remove('active'));
  chip.classList.add('active');
  renderLeads(chip.dataset.filter);
});

document.querySelectorAll('.fu-type-item').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.fu-type-item').forEach(i => i.classList.remove('active'));
    item.classList.add('active');
    renderFollowUps(item.dataset.type);
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MINI CALENDAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildMiniCal() {
  const now = new Date();
  document.getElementById('calMonth').textContent = now.toLocaleString('default', {month:'long', year:'numeric'});
  const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
  const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
  const today = now.getDate();

  let html = ['S','M','T','W','T','F','S'].map(d => `<div class="mcg-day-name">${d}</div>`).join('');
  for(let i = 0; i < firstDay; i++) html += '<div></div>';
  for(let d = 1; d <= daysInMonth; d++) {
    const isToday = d === today;
    html += `<div class="mcg-day${isToday?' today':''}">${d}</div>`;
  }
  document.getElementById('miniCal').innerHTML = `<div class="mini-cal-grid">${html}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setDbStatus(ok, msg) {
  const dot = document.getElementById('dbDot');
  const txt = document.getElementById('dbStatusText');
  dot.className = 'db-dot ' + (ok ? 'connected' : 'error');
  txt.textContent = msg;
}

function updateDate() {
  const now = new Date();
  const h = now.getHours();
  const greet = h < 12 ? 'Good morning' : h < 17 ? 'Good afternoon' : 'Good evening';
  document.getElementById('dashGreeting').textContent = greet + ' ‚òÄÔ∏è';
  document.getElementById('dashDate').textContent = now.toLocaleDateString('en-IN', {
    weekday:'long', day:'numeric', month:'long', year:'numeric'
  }) + ' ¬∑ Real Estate CRM';
}

function formatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString('en-IN', {weekday:'long', day:'2-digit', month:'long'});
}

function esc(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

let toastTimer;
function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  const icon = type === 'error' ? '‚ùå' : type === 'info' ? 'üí°' : '‚úÖ';
  document.getElementById('toastIcon').textContent = icon;
  document.getElementById('toastMsg').textContent = msg;
  t.className = 'toast show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('load', () => {
  const cfg = getSavedConfig();
  if (cfg && cfg.projectId && cfg.projectId !== 'YOUR_PROJECT_ID') {
    document.getElementById('setupBanner').style.display = 'none';
  }
  updateDate();
  buildMiniCal();
  // If firebase module sets _dbReady before our listener, handle it
  if (window._dbReady) {
    setDbStatus(true, 'Connected');
    _dbConnected = true;
    document.getElementById('setupBanner').style.display = 'none';
    loadLeadsFromDB();
    loadFollowUpsFromDB();
  } else {
    window.addEventListener('dbReady', () => {
      setDbStatus(true, 'Connected');
      _dbConnected = true;
      document.getElementById('setupBanner').style.display = 'none';
      loadLeadsFromDB();
      loadFollowUpsFromDB();
    }, { once: true });
    // If no config, go demo
    if (!cfg || !cfg.projectId || cfg.projectId === 'YOUR_PROJECT_ID') {
      useDemoMode();
    }
  }
});
</script>
</body>
</html>
