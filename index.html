<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SalesFun — Real Estate CRM</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAz-44QWWH4lcXu9I7Xs56RCsjSbmSHNuo",
    authDomain: "fir-config-9023d.firebaseapp.com",
    projectId: "fir-config-9023d",
    storageBucket: "fir-config-9023d.firebasestorage.app",
    messagingSenderId: "178665965729",
    appId: "1:178665965729:web:57fcb0f607a1420c8e08e0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window._db = db;
  window._firebase = { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot, serverTimestamp, where };
  window._dbReady = true;

  window.addEventListener('DOMContentLoaded', () => {
    initApp();
  });
</script>

<style>
:root {
  --bg:#0f0e0c; --bg2:#161410; --bg3:#1e1b16; --bg4:#26221b; --bg5:#2e2920;
  --border:rgba(255,220,140,0.08); --border2:rgba(255,220,140,0.16);
  --gold:#d4a843; --gold2:#f0c96a; --gold-dim:rgba(212,168,67,0.12); --gold-glow:rgba(212,168,67,0.22);
  --text:#f0ead8; --text2:#9a9080; --text3:#5a5045;
  --green:#4caf7d; --green-dim:rgba(76,175,125,0.12);
  --red:#e05555; --red-dim:rgba(224,85,85,0.12);
  --blue:#6ba3d6; --blue-dim:rgba(107,163,214,0.12);
  --orange:#e8924a; --orange-dim:rgba(232,146,74,0.12);
  --purple:#a78bfa; --purple-dim:rgba(167,139,250,0.12);
  --teal:#2dd4bf; --teal-dim:rgba(45,212,191,0.12);
  --r:10px; --r-sm:7px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;}

/* ── TOPBAR ── */
.topbar{height:54px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 18px;gap:14px;flex-shrink:0;z-index:100;}
.logo{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--gold2);letter-spacing:.02em;display:flex;align-items:center;gap:8px;cursor:pointer;flex-shrink:0;}
.logo-icon{width:30px;height:30px;background:linear-gradient(135deg,var(--gold),var(--gold2));border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:14px;color:#0f0e0c;font-weight:700;}
.top-search{flex:1;max-width:340px;margin:0 10px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;padding:0 12px;gap:8px;height:34px;}
.top-search input{background:none;border:none;outline:none;color:var(--text);font-family:inherit;font-size:13px;width:100%;}
.top-search input::placeholder{color:var(--text3);}
.top-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
.t-btn{height:32px;padding:0 14px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);font-family:inherit;font-size:12px;font-weight:500;border-radius:7px;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .2s;}
.t-btn:hover{border-color:var(--border2);color:var(--text);background:var(--bg4);}
.t-btn.gold{background:var(--gold-dim);border-color:rgba(212,168,67,.3);color:var(--gold);}
.t-btn.gold:hover{background:var(--gold-glow);}
.notif-btn{width:32px;height:32px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text2);transition:all .2s;position:relative;}
.notif-badge{position:absolute;top:-3px;right:-3px;width:15px;height:15px;background:var(--red);border-radius:50%;font-size:8px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;border:2px solid var(--bg2);}
.avatar{width:32px;height:32px;background:linear-gradient(135deg,#8b4513,var(--gold));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;cursor:pointer;flex-shrink:0;}

/* ── LAYOUT ── */
.app-body{flex:1;display:flex;overflow:hidden;}

/* ── SIDENAV ── */
.sidenav{width:220px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:14px 10px;gap:2px;flex-shrink:0;overflow-y:auto;}
.sidenav::-webkit-scrollbar{width:0;}
.nav-section-label{font-size:10px;font-weight:600;letter-spacing:.1em;color:var(--text3);text-transform:uppercase;padding:10px 10px 4px;margin-top:4px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:8px;cursor:pointer;color:var(--text2);font-size:13px;font-weight:500;transition:all .15s;position:relative;}
.nav-item:hover{background:var(--bg3);color:var(--text);}
.nav-item.active{background:var(--gold-dim);color:var(--gold);}
.nav-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:20px;background:var(--gold);border-radius:0 2px 2px 0;}
.nav-item svg{flex-shrink:0;}
.nav-badge{margin-left:auto;font-size:10px;font-weight:700;background:var(--bg4);color:var(--text2);padding:1px 6px;border-radius:20px;min-width:18px;text-align:center;}
.nav-badge.hot{background:var(--red-dim);color:var(--red);}
.nav-badge.new{background:var(--green-dim);color:var(--green);}
.nav-badge.prop{background:var(--purple-dim);color:var(--purple);}
.nav-divider{height:1px;background:var(--border);margin:8px 0;}
.nav-spacer{flex:1;}
.nav-agent-card{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px;margin-top:4px;}
.nac-top{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.nac-avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,#8b4513,var(--gold));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0;}
.nac-name{font-size:12px;font-weight:600;color:var(--text);}
.nac-role{font-size:10px;color:var(--text3);}
.nac-stats{display:flex;gap:8px;}
.nac-stat{flex:1;text-align:center;}
.nac-stat-val{font-size:14px;font-weight:700;color:var(--gold);}
.nac-stat-lbl{font-size:9px;color:var(--text3);}

/* ── VIEWS ── */
.main{flex:1;overflow-y:auto;display:flex;flex-direction:column;min-width:0;}
.main::-webkit-scrollbar{width:6px;}
.main::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px;}
.view{display:none;flex:1;flex-direction:column;overflow:hidden;}
.view.active{display:flex;}
.page-header{padding:20px 24px 0;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.page-title h1{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:700;color:var(--text);letter-spacing:.01em;}
.page-title p{font-size:13px;color:var(--text2);margin-top:2px;}
.page-actions{display:flex;gap:8px;align-items:center;}

/* ── DASHBOARD ── */
.dash-content{padding:20px 24px;flex:1;overflow-y:auto;}
.dash-content::-webkit-scrollbar{width:6px;}
.dash-content::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px;}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:16px;transition:border-color .2s;cursor:default;animation:fadeUp .4s ease forwards;opacity:0;}
.stat-card:hover{border-color:var(--border2);}
.stat-card:nth-child(1){animation-delay:.05s;}
.stat-card:nth-child(2){animation-delay:.1s;}
.stat-card:nth-child(3){animation-delay:.15s;}
.stat-card:nth-child(4){animation-delay:.2s;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.sc-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.sc-icon{width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;}
.sc-val{font-size:28px;font-weight:700;color:var(--text);letter-spacing:-.5px;font-family:'Cormorant Garamond',serif;}
.sc-lbl{font-size:12px;color:var(--text2);margin-top:2px;}
.dash-grid{display:grid;grid-template-columns:1fr 340px;gap:14px;}
.dash-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;}
.dc-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.dc-title{font-size:14px;font-weight:600;color:var(--text);}
.dc-subtitle{font-size:11px;color:var(--text3);}
.dc-action{font-size:12px;color:var(--gold);cursor:pointer;text-decoration:none;}
.dc-action:hover{text-decoration:underline;}

/* pipeline */
.pipeline-cols{display:flex;gap:0;}
.pipeline-col{flex:1;border-right:1px solid var(--border);display:flex;flex-direction:column;}
.pipeline-col:last-child{border-right:none;}
.pc-header{padding:10px 12px;background:var(--bg3);border-bottom:1px solid var(--border);}
.pc-name{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.06em;}
.pc-count{font-size:10px;color:var(--text3);margin-top:1px;}
.pc-leads{padding:8px;display:flex;flex-direction:column;gap:6px;overflow-y:auto;max-height:200px;}
.pc-leads::-webkit-scrollbar{width:3px;}
.pc-leads::-webkit-scrollbar-thumb{background:var(--bg4);}
.lead-mini{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:8px;cursor:pointer;transition:all .15s;}
.lead-mini:hover{border-color:var(--border2);transform:translateY(-1px);}
.lm-name{font-size:12px;font-weight:600;color:var(--text);}
.lm-prop{font-size:11px;color:var(--text3);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.lm-budget{font-size:11px;color:var(--gold);font-weight:600;margin-top:4px;}

.activity-list{padding:10px 0;}
.act-item{display:flex;gap:12px;padding:10px 16px;border-bottom:1px solid var(--border);transition:background .15s;}
.act-item:last-child{border-bottom:none;}
.act-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:5px;}
.act-text{font-size:12px;color:var(--text2);line-height:1.5;}
.act-text strong{color:var(--text);}
.act-time{font-size:10px;color:var(--text3);margin-top:2px;}

.fu-dash-list{padding:8px 0;}
.fu-dash-item{display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;}
.fu-dash-item:hover{background:var(--bg3);}
.fu-dash-item:last-child{border-bottom:none;}
.fu-dash-av{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;background:var(--bg4);color:var(--text2);}
.fu-dash-info{flex:1;min-width:0;}
.fu-dash-name{font-size:13px;font-weight:600;color:var(--text);}
.fu-dash-note{font-size:11px;color:var(--text3);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.fu-dash-time{font-size:11px;font-weight:600;padding:3px 8px;border-radius:20px;flex-shrink:0;}
.fu-dash-time.urgent{background:var(--red-dim);color:var(--red);}
.fu-dash-time.today{background:var(--orange-dim);color:var(--orange);}
.fu-dash-time.upcoming{background:var(--blue-dim);color:var(--blue);}

/* ── LEADS VIEW ── */
.leads-content{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.leads-toolbar{padding:14px 24px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;}
.filter-chip{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:500;background:var(--bg3);border:1px solid var(--border);color:var(--text2);cursor:pointer;transition:all .15s;white-space:nowrap;}
.filter-chip:hover{border-color:var(--border2);color:var(--text);}
.filter-chip.active{background:var(--gold-dim);border-color:rgba(212,168,67,.3);color:var(--gold);}
.leads-table-wrap{flex:1;overflow-y:auto;padding:0 24px 20px;}
.leads-table-wrap::-webkit-scrollbar{width:6px;}
.leads-table-wrap::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px;}
table{width:100%;border-collapse:collapse;margin-top:14px;}
thead th{font-size:11px;font-weight:600;letter-spacing:.07em;text-transform:uppercase;color:var(--text3);padding:8px 12px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--border);transition:background .15s;cursor:pointer;}
tbody tr:hover{background:var(--bg2);}
tbody td{padding:12px 12px;font-size:13px;color:var(--text2);vertical-align:middle;}
.td-name{color:var(--text);font-weight:600;}
.td-phone{font-family:'JetBrains Mono',monospace;font-size:12px;}
.td-budget{color:var(--gold);font-weight:600;}
.td-actions{display:flex;gap:6px;}
.row-btn{height:26px;padding:0 10px;background:var(--bg3);border:1px solid var(--border);color:var(--text3);font-family:inherit;font-size:11px;border-radius:6px;cursor:pointer;transition:all .15s;white-space:nowrap;}
.row-btn:hover{border-color:var(--border2);color:var(--text);}
.row-btn.del:hover{border-color:rgba(224,85,85,.4);color:var(--red);}

/* ── FOLLOW-UPS VIEW ── */
.fu-content{flex:1;display:flex;overflow:hidden;}
.fu-sidebar{width:260px;border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;}
.fu-main-area{flex:1;overflow-y:auto;padding:20px 24px;}
.fu-main-area::-webkit-scrollbar{width:6px;}
.fu-main-area::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px;}
.fu-cal-header{padding:14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.fu-cal-title{font-size:13px;font-weight:600;}
.mini-cal{padding:12px;}
.mini-cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center;}
.mcg-day-name{font-size:9px;color:var(--text3);padding:2px 0;font-weight:600;}
.mcg-day{font-size:11px;padding:5px 3px;border-radius:5px;cursor:pointer;color:var(--text2);transition:all .15s;}
.mcg-day:hover{background:var(--bg3);color:var(--text);}
.mcg-day.today{background:var(--gold-dim);color:var(--gold);font-weight:700;}
.mcg-day.has-fu::after{content:'';display:block;width:4px;height:4px;background:var(--green);border-radius:50%;margin:2px auto 0;}
.fu-type-list{padding:10px;border-top:1px solid var(--border);}
.fu-type-item{display:flex;align-items:center;gap:8px;padding:7px 8px;border-radius:7px;cursor:pointer;transition:background .15s;font-size:12px;color:var(--text2);}
.fu-type-item:hover{background:var(--bg3);color:var(--text);}
.fu-type-item.active{background:var(--gold-dim);color:var(--gold);}
.fu-type-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.fu-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:12px;cursor:pointer;transition:all .2s;animation:fadeUp .3s ease forwards;opacity:0;}
.fu-card:hover{border-color:var(--border2);}
.fu-card-top{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
.fu-card-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0;background:var(--bg4);color:var(--text2);}
.fu-card-info{flex:1;min-width:0;}
.fu-card-name{font-size:14px;font-weight:600;color:var(--text);}
.fu-card-sub{font-size:12px;color:var(--text3);margin-top:1px;}
.fu-card-badges{display:flex;gap:6px;align-items:center;flex-shrink:0;}
.fu-body{background:var(--bg3);border-radius:7px;padding:10px;font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:10px;}
.fu-footer{display:flex;align-items:center;gap:8px;}
.fu-action-btn{flex:1;height:30px;border-radius:7px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-family:inherit;font-size:11px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;transition:all .15s;}
.fu-action-btn:hover{border-color:var(--border2);color:var(--text);}
.fu-action-btn.primary{background:var(--gold-dim);border-color:rgba(212,168,67,.3);color:var(--gold);}
.fu-action-btn.primary:hover{background:var(--gold-glow);}
.fu-action-btn.danger{background:var(--red-dim);border-color:rgba(224,85,85,.3);color:var(--red);}

/* ══════════════════════════════════════
   PROPERTIES VIEW
══════════════════════════════════════ */
.props-content{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.props-toolbar{padding:14px 24px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;}
.props-table-wrap{flex:1;overflow-y:auto;padding:0 24px 20px;}
.props-table-wrap::-webkit-scrollbar{width:6px;}
.props-table-wrap::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px;}

/* Property card grid */
.props-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;padding:20px 24px;}
.prop-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;transition:all .2s;animation:fadeUp .35s ease forwards;opacity:0;cursor:pointer;}
.prop-card:hover{border-color:var(--border2);transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,.3);}
.prop-card:nth-child(1){animation-delay:.05s;}
.prop-card:nth-child(2){animation-delay:.1s;}
.prop-card:nth-child(3){animation-delay:.15s;}
.prop-card:nth-child(4){animation-delay:.2s;}
.prop-card:nth-child(5){animation-delay:.25s;}
.prop-card:nth-child(6){animation-delay:.3s;}

.prop-card-img{height:140px;background:var(--bg3);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;}
.prop-card-img-bg{position:absolute;inset:0;opacity:.07;}
.prop-card-img-icon{font-size:42px;position:relative;z-index:1;}
.prop-card-img-overlay{position:absolute;inset:0;background:linear-gradient(to top,rgba(15,14,12,.8),transparent);z-index:2;}
.prop-card-img-badges{position:absolute;top:10px;left:10px;z-index:3;display:flex;gap:6px;flex-wrap:wrap;}
.prop-card-img-price{position:absolute;bottom:10px;right:10px;z-index:3;font-size:15px;font-weight:700;color:var(--gold2);font-family:'Cormorant Garamond',serif;}

.prop-card-body{padding:14px;}
.prop-card-title{font-size:14px;font-weight:700;color:var(--text);margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.prop-card-sub{font-size:12px;color:var(--text3);margin-bottom:10px;display:flex;align-items:center;gap:4px;}
.prop-meta-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
.prop-meta{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text2);background:var(--bg3);border:1px solid var(--border);border-radius:5px;padding:3px 7px;}
.prop-supplier-row{display:flex;align-items:center;gap:8px;padding-top:10px;border-top:1px solid var(--border);}
.prop-supplier-av{width:28px;height:28px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:var(--text2);flex-shrink:0;}
.prop-supplier-info{flex:1;min-width:0;}
.prop-supplier-name{font-size:12px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.prop-supplier-role{font-size:10px;color:var(--text3);}
.prop-card-actions{display:flex;gap:6px;}
.prop-action-btn{flex:1;height:28px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--text3);font-family:inherit;font-size:11px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:4px;}
.prop-action-btn:hover{border-color:var(--border2);color:var(--text);}
.prop-action-btn.del:hover{border-color:rgba(224,85,85,.4);color:var(--red);background:var(--red-dim);}

/* View toggle */
.view-toggle{display:flex;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:3px;gap:2px;}
.vt-btn{width:28px;height:26px;border-radius:5px;border:none;background:transparent;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;font-size:13px;}
.vt-btn.active{background:var(--bg4);color:var(--text);}

/* Property status colors */
.prop-avail{background:var(--green-dim);color:var(--green);border:1px solid rgba(76,175,125,.2);}
.prop-nego{background:var(--gold-dim);color:var(--gold);border:1px solid rgba(212,168,67,.2);}
.prop-sold{background:rgba(90,80,69,.3);color:var(--text3);border:1px solid var(--border);}
.prop-hold{background:var(--orange-dim);color:var(--orange);border:1px solid rgba(232,146,74,.2);}

/* ── TAGS & BADGES ── */
.tag{font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px;}
.tag-hot{background:var(--red-dim);color:var(--red);}
.tag-warm{background:var(--orange-dim);color:var(--orange);}
.tag-cold{background:var(--blue-dim);color:var(--blue);}
.tag-vip{background:var(--gold-dim);color:var(--gold);}
.tag-new{background:var(--green-dim);color:var(--green);}
.status-pill{display:inline-flex;align-items:center;gap:5px;font-size:10px;font-weight:600;padding:3px 8px;border-radius:20px;}
.pill-new{background:var(--green-dim);color:var(--green);border:1px solid rgba(76,175,125,.2);}
.pill-contacted{background:var(--blue-dim);color:var(--blue);border:1px solid rgba(107,163,214,.2);}
.pill-site{background:var(--orange-dim);color:var(--orange);border:1px solid rgba(232,146,74,.2);}
.pill-nego{background:var(--gold-dim);color:var(--gold);border:1px solid rgba(212,168,67,.2);}
.pill-closed{background:var(--green-dim);color:var(--green);border:1px solid rgba(76,175,125,.2);}
.pill-lost{background:rgba(90,80,69,.3);color:var(--text3);border:1px solid var(--border);}

/* ── MODALS ── */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:14px;width:580px;max-width:95vw;max-height:90vh;overflow-y:auto;animation:fadeUp .3s ease;}
.modal.wide{width:680px;}
.modal::-webkit-scrollbar{width:4px;}
.modal::-webkit-scrollbar-thumb{background:var(--bg4);}
.modal-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--bg2);z-index:1;}
.modal-header h3{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;}
.modal-close{width:30px;height:30px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text2);transition:all .15s;}
.modal-close:hover{border-color:var(--border2);color:var(--text);}
.modal-body{padding:20px;}
.modal-section{margin-bottom:20px;}
.modal-section-title{font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);padding-bottom:10px;border-bottom:1px solid var(--border);margin-bottom:14px;display:flex;align-items:center;gap:7px;}
.form-row{margin-bottom:14px;}
.form-label{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;display:block;}
.form-input,.form-select,.form-textarea{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-family:inherit;font-size:13px;outline:none;transition:border-color .2s;}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:rgba(212,168,67,.4);}
.form-input::placeholder,.form-textarea::placeholder{color:var(--text3);}
.form-select option{background:var(--bg3);}
.form-textarea{resize:vertical;min-height:72px;line-height:1.5;}
.form-2col{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-3col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
.modal-footer{padding:14px 20px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;}
.btn-cancel{padding:0 16px;height:34px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);font-family:inherit;font-size:13px;border-radius:8px;cursor:pointer;transition:all .15s;}
.btn-cancel:hover{border-color:var(--border2);color:var(--text);}
.btn-save{padding:0 20px;height:34px;background:var(--gold);border:none;color:#000;font-family:inherit;font-size:13px;font-weight:700;border-radius:8px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px;}
.btn-save:hover{background:var(--gold2);transform:translateY(-1px);}
.btn-save:disabled{opacity:.5;cursor:not-allowed;transform:none;}

/* ── EMPTY STATE ── */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;color:var(--text3);gap:12px;flex:1;}
.empty-state-icon{font-size:52px;opacity:.4;}
.empty-state h3{font-size:18px;font-weight:600;color:var(--text2);}
.empty-state p{font-size:13px;text-align:center;max-width:320px;line-height:1.6;}

/* ── LOADING ── */
.loading{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--text3);gap:10px;font-size:13px;}
.spinner{width:18px;height:18px;border:2px solid var(--bg4);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0;}
@keyframes spin{to{transform:rotate(360deg);}}

/* ── DB STATUS ── */
.db-status{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text3);}
.db-dot{width:6px;height:6px;border-radius:50%;background:var(--text3);}
.db-dot.connected{background:var(--green);box-shadow:0 0 6px rgba(76,175,125,.5);}
.db-dot.error{background:var(--red);}

/* ── TOAST ── */
.toast{position:fixed;bottom:24px;right:24px;background:var(--bg2);border:1px solid rgba(212,168,67,.3);border-radius:10px;padding:12px 16px;z-index:9999;display:flex;align-items:center;gap:10px;font-size:13px;color:var(--text);transform:translateY(20px);opacity:0;transition:all .3s;pointer-events:none;min-width:220px;box-shadow:0 8px 30px rgba(0,0,0,.5);}
.toast.show{transform:translateY(0);opacity:1;}
.toast.success{border-color:rgba(76,175,125,.3);}
.toast.error{border-color:rgba(224,85,85,.3);}

/* Property detail modal */
.prop-detail-header{background:var(--bg3);padding:16px;border-radius:10px;margin-bottom:16px;display:flex;gap:14px;align-items:flex-start;}
.prop-detail-icon{width:56px;height:56px;border-radius:12px;background:var(--purple-dim);border:1px solid rgba(167,139,250,.2);display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0;}
.prop-detail-meta{flex:1;}
.prop-detail-title{font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:700;color:var(--text);}
.prop-detail-loc{font-size:13px;color:var(--text3);margin-top:3px;}
.prop-detail-price{font-size:22px;font-weight:700;color:var(--gold);font-family:'Cormorant Garamond',serif;margin-top:4px;}
.prop-info-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px;}
.prop-info-item{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;}
.prop-info-label{font-size:10px;color:var(--text3);font-weight:600;letter-spacing:.07em;text-transform:uppercase;margin-bottom:4px;}
.prop-info-value{font-size:13px;font-weight:600;color:var(--text);}

::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px;}

/* ══════════════════════════════════════
   WHATSAPP / VIP CONTACTS
══════════════════════════════════════ */
--wa:#25d366; --wa-dim:rgba(37,211,102,0.12); --wa-glow:rgba(37,211,102,0.22);

.nav-badge.wa{background:var(--wa-dim);color:#25d366;}

/* VIP Contacts view */
.vip-content{flex:1;display:flex;overflow:hidden;}
.vip-contacts-panel{width:320px;border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;}
.vip-panel-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.vip-panel-title{font-size:13px;font-weight:700;color:var(--text);}
.vip-contacts-list{flex:1;overflow-y:auto;padding:10px;}
.vip-contact-card{background:var(--bg3);border:1px solid var(--border);border-radius:9px;padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;gap:10px;transition:all .15s;cursor:pointer;animation:fadeUp .3s ease forwards;opacity:0;}
.vip-contact-card:hover{border-color:var(--border2);}
.vip-contact-card:nth-child(1){animation-delay:.05s;}
.vip-contact-card:nth-child(2){animation-delay:.1s;}
.vip-contact-card:nth-child(3){animation-delay:.15s;}
.vcc-avatar{width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,#1a6b3a,#25d366);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0;}
.vcc-info{flex:1;min-width:0;}
.vcc-name{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.vcc-phone{font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--text3);margin-top:1px;}
.vcc-tag{font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;background:#25d36620;color:#25d366;margin-top:3px;display:inline-block;}
.vcc-actions{display:flex;gap:5px;}
.vcc-btn{width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:var(--bg4);color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;transition:all .15s;}
.vcc-btn:hover{border-color:var(--border2);color:var(--text);}
.vcc-btn.wa-btn{background:#25d36615;border-color:#25d36630;color:#25d366;}
.vcc-btn.wa-btn:hover{background:#25d36625;}
.vcc-btn.del-btn:hover{background:var(--red-dim);border-color:rgba(224,85,85,.3);color:var(--red);}

/* Broadcast panel */
.vip-broadcast-panel{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.vip-broadcast-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.vip-bc-title{font-size:14px;font-weight:700;color:var(--text);}
.vip-bc-sub{font-size:12px;color:var(--text3);margin-top:2px;}
.vip-broadcast-body{flex:1;overflow-y:auto;padding:16px 20px;}
.bc-template-box{background:var(--bg3);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:16px;}
.bc-template-header{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;background:var(--bg4);}
.bc-template-label{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;}
.bc-template-wa-icon{width:22px;height:22px;border-radius:6px;background:#25d366;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;}
.bc-template-textarea{width:100%;background:transparent;border:none;outline:none;padding:12px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;line-height:1.6;resize:vertical;min-height:140px;}
.bc-vars{display:flex;gap:6px;padding:8px 14px 10px;border-top:1px solid var(--border);flex-wrap:wrap;}
.bc-var{font-size:10px;font-weight:600;padding:3px 8px;border-radius:20px;background:var(--gold-dim);color:var(--gold);border:1px solid rgba(212,168,67,.2);cursor:pointer;transition:all .15s;}
.bc-var:hover{background:var(--gold-glow);}

.bc-recipient-list{display:flex;flex-direction:column;gap:8px;}
.bc-recipient-row{background:var(--bg2);border:1px solid var(--border);border-radius:9px;padding:12px 14px;display:flex;align-items:center;gap:12px;animation:fadeUp .25s ease forwards;opacity:0;}
.bc-recipient-row:nth-child(1){animation-delay:.04s;}
.bc-recipient-row:nth-child(2){animation-delay:.08s;}
.bc-recipient-row:nth-child(3){animation-delay:.12s;}
.bc-recipient-row:nth-child(4){animation-delay:.16s;}
.bc-rec-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#1a6b3a,#25d366);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;flex-shrink:0;}
.bc-rec-info{flex:1;min-width:0;}
.bc-rec-name{font-size:13px;font-weight:600;color:var(--text);}
.bc-rec-phone{font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace;}
.bc-rec-status{font-size:11px;font-weight:600;padding:2px 8px;border-radius:20px;flex-shrink:0;}
.bc-rec-status.sent{background:#25d36615;color:#25d366;border:1px solid #25d36630;}
.bc-rec-status.pending{background:var(--orange-dim);color:var(--orange);border:1px solid rgba(232,146,74,.2);}
.bc-send-btn{height:30px;padding:0 14px;border-radius:7px;border:1px solid #25d36640;background:#25d36618;color:#25d366;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .15s;white-space:nowrap;flex-shrink:0;}
.bc-send-btn:hover{background:#25d36628;transform:translateY(-1px);}
.bc-send-btn.sent-state{background:rgba(76,175,125,.15);border-color:rgba(76,175,125,.3);color:var(--green);cursor:default;transform:none;}

/* WhatsApp broadcast MODAL (new lead trigger) */
.wa-modal{background:var(--bg2);border:1px solid rgba(37,211,102,.2);border-radius:14px;width:560px;max-width:95vw;max-height:90vh;overflow-y:auto;animation:fadeUp .3s ease;box-shadow:0 20px 60px rgba(0,0,0,.6);}
.wa-modal-header{padding:16px 20px;border-bottom:1px solid rgba(37,211,102,.15);display:flex;align-items:center;gap:12px;}
.wa-modal-icon{width:40px;height:40px;background:linear-gradient(135deg,#128C7E,#25D366);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;}
.wa-modal-titles{flex:1;}
.wa-modal-titles h3{font-family:'Cormorant Garamond',serif;font-size:21px;font-weight:700;color:var(--text);}
.wa-modal-titles p{font-size:12px;color:var(--text3);margin-top:2px;}
.wa-lead-banner{background:linear-gradient(135deg,rgba(37,211,102,.08),rgba(37,211,102,.04));border:1px solid rgba(37,211,102,.15);border-radius:10px;padding:14px;margin-bottom:16px;display:flex;gap:12px;align-items:center;}
.wa-lead-av{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#000;flex-shrink:0;}
.wa-lead-details{flex:1;}
.wa-lead-name{font-size:15px;font-weight:700;color:var(--text);}
.wa-lead-meta{font-size:12px;color:var(--text3);margin-top:3px;}
.wa-new-badge{font-size:10px;font-weight:700;padding:3px 10px;border-radius:20px;background:#25d36620;color:#25d366;border:1px solid #25d36640;flex-shrink:0;}
.wa-msg-preview{background:var(--bg3);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:16px;}
.wa-msg-preview-header{padding:9px 14px;border-bottom:1px solid var(--border);font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;display:flex;align-items:center;justify-content:space-between;}
.wa-msg-edit-btn{font-size:11px;color:var(--gold);cursor:pointer;}
.wa-msg-edit-btn:hover{text-decoration:underline;}
.wa-msg-body{padding:12px 14px;font-size:13px;color:var(--text2);line-height:1.7;white-space:pre-wrap;word-break:break-word;}
.wa-msg-body textarea{width:100%;background:transparent;border:none;outline:none;color:var(--text2);font-family:'DM Sans',sans-serif;font-size:13px;line-height:1.7;resize:none;min-height:100px;}
.wa-contacts-header{font-size:12px;font-weight:700;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;}
.wa-contacts-count{font-size:11px;font-weight:600;padding:2px 8px;border-radius:20px;background:#25d36618;color:#25d366;}
.wa-contact-row{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;animation:fadeUp .2s ease forwards;opacity:0;}
.wa-contact-row:nth-child(1){animation-delay:.03s;}
.wa-contact-row:nth-child(2){animation-delay:.06s;}
.wa-contact-row:nth-child(3){animation-delay:.09s;}
.wa-contact-row:nth-child(4){animation-delay:.12s;}
.wa-contact-row:nth-child(5){animation-delay:.15s;}
.wc-av{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#1a6b3a,#25d366);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0;}
.wc-info{flex:1;min-width:0;}
.wc-name{font-size:13px;font-weight:600;color:var(--text);}
.wc-phone{font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace;}
.wc-send-btn{height:30px;padding:0 14px;border-radius:7px;border:1px solid #25d36640;background:#25d36618;color:#25d366;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .15s;white-space:nowrap;flex-shrink:0;}
.wc-send-btn:hover{background:#25d36628;transform:translateY(-1px);}
.wc-send-btn.sent{background:rgba(76,175,125,.15);border-color:rgba(76,175,125,.3);color:var(--green);pointer-events:none;}
.wa-modal-footer{padding:14px 20px;border-top:1px solid rgba(37,211,102,.12);display:flex;gap:8px;justify-content:space-between;align-items:center;}
.wa-send-all-btn{padding:0 20px;height:36px;background:linear-gradient(135deg,#128C7E,#25D366);border:none;color:#fff;font-family:inherit;font-size:13px;font-weight:700;border-radius:9px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .2s;box-shadow:0 4px 14px rgba(37,211,102,.25);}
.wa-send-all-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(37,211,102,.35);}
.wa-sent-count{font-size:12px;color:var(--text3);}
.wa-sent-count strong{color:#25d366;}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="logo" onclick="setView('dashboard')">
    <div class="logo-icon">P</div>
    SalesFun
  </div>
  <div class="top-search">
    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="color:var(--text3)"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" id="globalSearch" placeholder="Search leads, properties…" oninput="handleSearch(this.value)">
  </div>
  <div class="top-right">
    <div class="db-status" id="dbStatus">
      <div class="db-dot" id="dbDot"></div>
      <span id="dbStatusText">Connecting…</span>
    </div>
    <div class="notif-btn" onclick="setView('followups')">
      <div class="notif-badge" id="todayFuBadge">0</div>
      <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
    </div>
    <button class="t-btn gold" onclick="openLeadModal()">
      <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Lead
    </button>
    <div class="avatar">RK</div>
  </div>
</div>

<!-- BODY -->
<div class="app-body">

<!-- SIDENAV -->
<nav class="sidenav">
  <div class="nav-section-label">Overview</div>
  <div class="nav-item active" id="nav-dashboard" onclick="setView('dashboard')">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
    Dashboard
  </div>
  <div class="nav-section-label">Work</div>
  <div class="nav-item" id="nav-leads" onclick="setView('leads')">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    Leads
    <span class="nav-badge hot" id="nav-leads-count">0</span>
  </div>
  <div class="nav-item" id="nav-followups" onclick="setView('followups')">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    Follow-ups
    <span class="nav-badge hot" id="nav-fu-count">0</span>
  </div>
  <div class="nav-item" id="nav-properties" onclick="setView('properties')">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    Properties
    <span class="nav-badge prop" id="nav-props-count">0</span>
  </div>
  <div class="nav-item" id="nav-vipcontacts" onclick="setView('vipcontacts')">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    VIP Broadcast
    <span class="nav-badge wa" id="nav-vip-count">0</span>
  </div>
  <div class="nav-spacer"></div>
  <div class="nav-agent-card">
    <div class="nac-top">
      <div class="nac-avatar">RK</div>
      <div><div class="nac-name">Your Name</div><div class="nac-role">Real Estate Agent</div></div>
    </div>
    <div class="nac-stats">
      <div class="nac-stat"><div class="nac-stat-val" id="stat-total">0</div><div class="nac-stat-lbl">Leads</div></div>
      <div class="nac-stat"><div class="nac-stat-val" id="stat-closed">0</div><div class="nac-stat-lbl">Closed</div></div>
      <div class="nac-stat"><div class="nac-stat-val" id="stat-hot">0</div><div class="nac-stat-lbl">Hot</div></div>
    </div>
  </div>
</nav>

<!-- MAIN -->
<div class="main">

<!-- ═══ DASHBOARD ═══ -->
<div class="view active" id="view-dashboard">
  <div class="page-header">
    <div class="page-title">
      <h1 id="dashGreeting">Good morning ☀️</h1>
      <p id="dashDate">Loading…</p>
    </div>
  </div>
  <div class="dash-content">
    <div class="stats-row">
      <div class="stat-card">
        <div class="sc-top"><div class="sc-icon" style="background:var(--gold-dim)"><svg width="18" height="18" fill="none" stroke="var(--gold)" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div></div>
        <div class="sc-val" id="dash-total">—</div><div class="sc-lbl">Total Leads</div>
      </div>
      <div class="stat-card">
        <div class="sc-top"><div class="sc-icon" style="background:var(--purple-dim)"><svg width="18" height="18" fill="none" stroke="var(--purple)" stroke-width="2" viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div></div>
        <div class="sc-val" id="dash-props">—</div><div class="sc-lbl">Properties Listed</div>
      </div>
      <div class="stat-card">
        <div class="sc-top"><div class="sc-icon" style="background:var(--orange-dim)"><svg width="18" height="18" fill="none" stroke="var(--orange)" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div></div>
        <div class="sc-val" id="dash-today-fu">—</div><div class="sc-lbl">Follow-ups Today</div>
      </div>
      <div class="stat-card">
        <div class="sc-top"><div class="sc-icon" style="background:var(--green-dim)"><svg width="18" height="18" fill="none" stroke="var(--green)" stroke-width="2" viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></div></div>
        <div class="sc-val" id="dash-closed">—</div><div class="sc-lbl">Deals Closed</div>
      </div>
    </div>

    <div class="dash-grid">
      <div class="dash-card">
        <div class="dc-header">
          <div><div class="dc-title">Lead Pipeline</div><div class="dc-subtitle">Live from database</div></div>
          <a class="dc-action" onclick="setView('leads')">View all →</a>
        </div>
        <div class="pipeline-cols" style="min-height:200px" id="pipelineCols">
          <div class="pipeline-col">
            <div class="pc-header"><div class="pc-name" style="color:var(--blue)">New</div><div class="pc-count" id="pc-new">0 leads</div></div>
            <div class="pc-leads" id="pc-leads-new"><div class="loading"><div class="spinner"></div></div></div>
          </div>
          <div class="pipeline-col">
            <div class="pc-header"><div class="pc-name" style="color:var(--orange)">Site Visit</div><div class="pc-count" id="pc-site">0 leads</div></div>
            <div class="pc-leads" id="pc-leads-site"></div>
          </div>
          <div class="pipeline-col">
            <div class="pc-header"><div class="pc-name" style="color:var(--gold)">Negotiation</div><div class="pc-count" id="pc-nego">0 leads</div></div>
            <div class="pc-leads" id="pc-leads-nego"></div>
          </div>
          <div class="pipeline-col">
            <div class="pc-header"><div class="pc-name" style="color:var(--green)">Closed</div><div class="pc-count" id="pc-closed">0 leads</div></div>
            <div class="pc-leads" id="pc-leads-closed"></div>
          </div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:14px">
        <div class="dash-card">
          <div class="dc-header">
            <div><div class="dc-title">Today's Follow-ups</div><div class="dc-subtitle" id="dash-fu-subtitle">Loading…</div></div>
            <a class="dc-action" onclick="setView('followups')">See all →</a>
          </div>
          <div id="dash-fu-list" class="fu-dash-list"><div class="loading"><div class="spinner"></div>Loading…</div></div>
        </div>
        <div class="dash-card">
          <div class="dc-header"><div class="dc-title">Quick Add Lead</div></div>
          <div style="padding:14px">
            <div style="display:flex;gap:8px;margin-bottom:8px">
              <input class="form-input" style="flex:1" id="quick-name" placeholder="Full name">
              <input class="form-input" style="flex:1" id="quick-phone" placeholder="+91 phone">
            </div>
            <div style="display:flex;gap:8px">
              <input class="form-input" style="flex:1" id="quick-budget" placeholder="Budget (e.g. ₹1.5 Cr)">
              <button class="btn-save" style="flex-shrink:0" onclick="quickAddLead()">Add →</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ═══ LEADS VIEW ═══ -->
<div class="view" id="view-leads">
  <div class="page-header">
    <div class="page-title"><h1>Leads</h1><p id="leads-subtitle">Loading from database…</p></div>
    <div class="page-actions">
      <button class="t-btn gold" onclick="openLeadModal()">
        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Lead
      </button>
    </div>
  </div>
  <div class="leads-content">
    <div class="leads-toolbar" id="leadsToolbar">
      <div class="filter-chip active" data-filter="all">All (<span id="chip-all">0</span>)</div>
      <div class="filter-chip" data-filter="New">New (<span id="chip-new">0</span>)</div>
      <div class="filter-chip" data-filter="Contacted">Contacted (<span id="chip-contacted">0</span>)</div>
      <div class="filter-chip" data-filter="Site Visit">Site Visit (<span id="chip-site">0</span>)</div>
      <div class="filter-chip" data-filter="Negotiation">Negotiation (<span id="chip-nego">0</span>)</div>
      <div class="filter-chip" data-filter="Closed">Closed (<span id="chip-closed">0</span>)</div>
      <div class="filter-chip" data-filter="Lost">Lost (<span id="chip-lost">0</span>)</div>
    </div>
    <div class="leads-table-wrap">
      <table>
        <thead><tr><th>Name</th><th>Phone</th><th>Budget</th><th>Interest</th><th>Source</th><th>Stage</th><th>Priority</th><th>Added</th><th>Actions</th></tr></thead>
        <tbody id="leadsTableBody"><tr><td colspan="9"><div class="loading"><div class="spinner"></div>Connecting to database…</div></td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ═══ FOLLOW-UPS VIEW ═══ -->
<div class="view" id="view-followups">
  <div class="page-header">
    <div class="page-title"><h1>Follow-ups</h1><p id="fu-subtitle">Loading…</p></div>
    <div class="page-actions">
      <button class="t-btn gold" onclick="openFollowUpModal()">
        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Follow-up
      </button>
    </div>
  </div>
  <div class="fu-content">
    <div class="fu-sidebar">
      <div class="fu-cal-header"><span class="fu-cal-title" id="calMonth">February 2026</span></div>
      <div class="mini-cal" id="miniCal"></div>
      <div class="fu-type-list">
        <div class="fu-type-item active" data-type="all"><div class="fu-type-dot" style="background:var(--gold)"></div> All Follow-ups</div>
        <div class="fu-type-item" data-type="Call"><div class="fu-type-dot" style="background:var(--blue)"></div> Calls</div>
        <div class="fu-type-item" data-type="WhatsApp"><div class="fu-type-dot" style="background:var(--green)"></div> WhatsApp</div>
        <div class="fu-type-item" data-type="Site Visit"><div class="fu-type-dot" style="background:var(--orange)"></div> Site Visits</div>
        <div class="fu-type-item" data-type="Document"><div class="fu-type-dot" style="background:var(--red)"></div> Documents</div>
      </div>
    </div>
    <div class="fu-main-area" id="fuMainArea"><div class="loading"><div class="spinner"></div>Loading follow-ups…</div></div>
  </div>
</div>

<!-- ═══ PROPERTIES VIEW ═══ -->
<div class="view" id="view-properties">
  <div class="page-header">
    <div class="page-title">
      <h1>Property Listings</h1>
      <p id="props-subtitle">Manage supplier land & property inventory</p>
    </div>
    <div class="page-actions">
      <!-- View toggle -->
      <div class="view-toggle">
        <button class="vt-btn active" id="vt-grid" onclick="setPropView('grid')" title="Grid view">⊞</button>
        <button class="vt-btn" id="vt-table" onclick="setPropView('table')" title="Table view">☰</button>
      </div>
      <button class="t-btn gold" onclick="openPropertyModal()">
        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Property
      </button>
    </div>
  </div>
  <div class="props-content">
    <div class="props-toolbar" id="propsToolbar">
      <div class="filter-chip active" data-pfilter="all">All (<span id="pchip-all">0</span>)</div>
      <div class="filter-chip" data-pfilter="Available">Available (<span id="pchip-avail">0</span>)</div>
      <div class="filter-chip" data-pfilter="Negotiation">Negotiation (<span id="pchip-nego">0</span>)</div>
      <div class="filter-chip" data-pfilter="On Hold">On Hold (<span id="pchip-hold">0</span>)</div>
      <div class="filter-chip" data-pfilter="Sold">Sold (<span id="pchip-sold">0</span>)</div>
      <div style="margin-left:auto;display:flex;gap:8px;">
        <select class="form-select" style="height:32px;padding:0 10px;font-size:12px;width:auto" id="propTypeFilter" onchange="renderProperties()">
          <option value="">All Types</option>
          <option>Agricultural Land</option>
          <option>Residential Plot</option>
          <option>Commercial Plot</option>
          <option>Apartment</option>
          <option>Villa / Bungalow</option>
          <option>Industrial Land</option>
          <option>Farm Land</option>
        </select>
      </div>
    </div>

    <!-- Grid view -->
    <div id="propsGridView" style="flex:1;overflow-y:auto;">
      <div class="props-grid" id="propsGrid">
        <div class="loading" style="grid-column:1/-1"><div class="spinner"></div>Loading properties…</div>
      </div>
    </div>

    <!-- Table view (hidden by default) -->
    <div id="propsTableView" style="flex:1;overflow-y:auto;display:none;padding:0 24px 20px;">
      <table style="margin-top:14px">
        <thead>
          <tr>
            <th>Property Title</th><th>Type</th><th>Location</th><th>Area</th>
            <th>Asking Price</th><th>Supplier</th><th>Status</th><th>Listed</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="propsTableBody">
          <tr><td colspan="9"><div class="loading"><div class="spinner"></div></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ═══ VIP BROADCAST VIEW ═══ -->
<div class="view" id="view-vipcontacts">
  <div class="page-header">
    <div class="page-title">
      <h1>VIP Broadcast</h1>
      <p id="vip-subtitle">WhatsApp broadcast list for new lead alerts</p>
    </div>
    <div class="page-actions">
      <button class="t-btn" onclick="openVipAddModal()" style="background:#25d36618;border-color:#25d36640;color:#25d366;">
        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add VIP Contact
      </button>
    </div>
  </div>
  <div class="vip-content">
    <div class="vip-contacts-panel">
      <div class="vip-panel-header">
        <div class="vip-panel-title">💚 VIP Contacts</div>
        <span class="nav-badge wa" id="vip-contacts-count">0</span>
      </div>
      <div class="vip-contacts-list" id="vipContactsList">
        <div class="loading"><div class="spinner"></div>Loading…</div>
      </div>
    </div>
    <div class="vip-broadcast-panel">
      <div class="vip-broadcast-header">
        <div>
          <div class="vip-bc-title">📢 Broadcast to All VIPs</div>
          <div class="vip-bc-sub" id="vip-bc-sub">Select a lead to broadcast to all VIP contacts</div>
        </div>
        <button class="t-btn" onclick="openBroadcastPickLead()" style="background:#25d36618;border-color:#25d36640;color:#25d366;">📣 Broadcast Lead</button>
      </div>
      <div class="vip-broadcast-body" id="vipBroadcastBody">
        <div style="margin-bottom:16px">
          <div class="bc-template-box">
            <div class="bc-template-header">
              <div class="bc-template-wa-icon">💬</div>
              <span class="bc-template-label">Message Template</span>
              <span style="margin-left:auto;font-size:11px;color:var(--text3)">Click variables to insert</span>
            </div>
            <textarea class="bc-template-textarea" id="bcTemplateText">🔔 *New Lead Alert!*

👤 *Name:* {leadName}
📞 *Phone:* {phone}
💰 *Budget:* {budget}
📍 *Looking in:* {location}
🏠 *Property:* {propType}

This lead just came in. Please reach out if interested in collaborating!

— SalesFun CRM</textarea>
            <div class="bc-vars">
              <span class="bc-var" onclick="insertVar('{leadName')">👤 leadName</span>
              <span class="bc-var" onclick="insertVar('{phone')">📞 phone</span>
              <span class="bc-var" onclick="insertVar('{budget')">💰 budget</span>
              <span class="bc-var" onclick="insertVar('{location')">📍 location</span>
              <span class="bc-var" onclick="insertVar('{propType')">🏠 propType</span>
              <span class="bc-var" onclick="insertVar('{source')">🔗 source</span>
              <span class="bc-var" onclick="insertVar('{stage')">📊 stage</span>
            </div>
          </div>
        </div>
        <div>
          <div class="wa-contacts-header"><span>Recent Broadcasts</span></div>
          <div id="recentBroadcasts" style="font-size:12px;color:var(--text3);padding:16px;text-align:center;background:var(--bg3);border-radius:8px;border:1px solid var(--border)">
            No broadcasts yet. Add VIP contacts and broadcast a lead to get started.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</div><!-- end main -->
</div><!-- end app-body -->

<!-- ════════ ADD LEAD MODAL ════════ -->
<div class="modal-overlay" id="leadModalOverlay" onclick="if(event.target===this)closeLeadModal()">
  <div class="modal">
    <div class="modal-header">
      <h3 id="leadModalTitle">Add New Lead</h3>
      <div class="modal-close" onclick="closeLeadModal()">✕</div>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editLeadId">
      <div class="form-2col">
        <div class="form-row"><label class="form-label">Full Name *</label><input class="form-input" id="f-name" placeholder="e.g. Arjun Sharma"></div>
        <div class="form-row"><label class="form-label">Phone *</label><input class="form-input" id="f-phone" placeholder="+91 98800 12345"></div>
      </div>
      <div class="form-2col">
        <div class="form-row"><label class="form-label">Email</label><input class="form-input" id="f-email" placeholder="arjun@email.com"></div>
        <div class="form-row"><label class="form-label">Budget</label><input class="form-input" id="f-budget" placeholder="₹ 1.5 Cr"></div>
      </div>
      <div class="form-2col">
        <div class="form-row"><label class="form-label">Property Type</label>
          <select class="form-select" id="f-proptype">
            <option value="">Select type</option>
            <option>1BHK Apartment</option><option>2BHK Apartment</option><option>3BHK Apartment</option>
            <option>4BHK Apartment</option><option>Villa</option><option>Studio</option>
            <option>Commercial</option><option>Plot</option><option>Penthouse</option>
          </select>
        </div>
        <div class="form-row"><label class="form-label">Preferred Location</label><input class="form-input" id="f-location" placeholder="Andheri East, Mumbai"></div>
      </div>
      <div class="form-2col">
        <div class="form-row"><label class="form-label">Lead Source</label>
          <select class="form-select" id="f-source">
            <option value="">Select source</option>
            <option>99acres</option><option>Housing.com</option><option>MagicBricks</option>
            <option>Instagram Ad</option><option>Facebook Ad</option><option>Google Ad</option>
            <option>Referral</option><option>Website</option><option>Walk-in</option><option>Cold Call</option>
          </select>
        </div>
        <div class="form-row"><label class="form-label">Pipeline Stage</label>
          <select class="form-select" id="f-stage">
            <option value="New">New</option><option value="Contacted">Contacted</option>
            <option value="Site Visit">Site Visit</option><option value="Negotiation">Negotiation</option>
            <option value="Closed">Closed</option><option value="Lost">Lost</option>
          </select>
        </div>
      </div>
      <div class="form-2col">
        <div class="form-row"><label class="form-label">Priority</label>
          <select class="form-select" id="f-priority">
            <option value="Normal">Normal</option><option value="Hot">🔥 Hot</option>
            <option value="Warm">Warm</option><option value="Cold">Cold</option><option value="VIP">⭐ VIP</option>
          </select>
        </div>
        <div class="form-row"><label class="form-label">WhatsApp Number</label><input class="form-input" id="f-wa" placeholder="Same as phone if same"></div>
      </div>
      <div class="form-row"><label class="form-label">Notes</label><textarea class="form-textarea" id="f-notes" placeholder="Key preferences, requirements, special notes…"></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeLeadModal()">Cancel</button>
      <button class="btn-save" id="saveLeadBtn" onclick="saveLead()">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
        Save Lead
      </button>
    </div>
  </div>
</div>

<!-- ════════ ADD FOLLOW-UP MODAL ════════ -->
<div class="modal-overlay" id="fuModalOverlay" onclick="if(event.target===this)closeFuModal()">
  <div class="modal">
    <div class="modal-header">
      <h3 id="fuModalTitle">Add Follow-up</h3>
      <div class="modal-close" onclick="closeFuModal()">✕</div>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editFuId">
      <div class="form-2col">
        <div class="form-row"><label class="form-label">Lead Name *</label>
          <select class="form-select" id="fu-leadId"><option value="">Select a lead</option></select>
        </div>
        <div class="form-row"><label class="form-label">Follow-up Type *</label>
          <select class="form-select" id="fu-type">
            <option value="Call">📞 Call</option><option value="WhatsApp">💬 WhatsApp</option>
            <option value="Site Visit">🏠 Site Visit</option><option value="Document">📄 Send Document</option>
            <option value="Email">📧 Email</option><option value="Meeting">🤝 Meeting</option>
          </select>
        </div>
      </div>
      <div class="form-2col">
        <div class="form-row"><label class="form-label">Date *</label><input class="form-input" id="fu-date" type="date"></div>
        <div class="form-row"><label class="form-label">Time</label><input class="form-input" id="fu-time" type="time" value="10:00"></div>
      </div>
      <div class="form-row"><label class="form-label">Priority</label>
        <select class="form-select" id="fu-priority">
          <option value="Normal">Normal</option><option value="Urgent">🔴 Urgent</option><option value="High">High</option>
        </select>
      </div>
      <div class="form-row"><label class="form-label">Notes / Reminder *</label>
        <textarea class="form-textarea" id="fu-notes" placeholder="What do you need to do in this follow-up? Be specific…"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeFuModal()">Cancel</button>
      <button class="btn-save" id="saveFuBtn" onclick="saveFollowUp()">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
        Save Follow-up
      </button>
    </div>
  </div>
</div>

<!-- ════════ ADD PROPERTY MODAL ════════ -->
<div class="modal-overlay" id="propModalOverlay" onclick="if(event.target===this)closePropModal()">
  <div class="modal wide">
    <div class="modal-header">
      <h3 id="propModalTitle">Add Property Listing</h3>
      <div class="modal-close" onclick="closePropModal()">✕</div>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editPropId">

      <!-- SECTION: Property Details -->
      <div class="modal-section">
        <div class="modal-section-title">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Property Details
        </div>
        <div class="form-row"><label class="form-label">Property Title *</label>
          <input class="form-input" id="p-title" placeholder="e.g. Green Valley Agricultural Land, Pune">
        </div>
        <div class="form-2col">
          <div class="form-row"><label class="form-label">Property Type *</label>
            <select class="form-select" id="p-type">
              <option value="">Select type</option>
              <option>Agricultural Land</option>
              <option>Residential Plot</option>
              <option>Commercial Plot</option>
              <option>Apartment</option>
              <option>Villa / Bungalow</option>
              <option>Industrial Land</option>
              <option>Farm Land</option>
              <option>Warehouse / Godown</option>
              <option>Office Space</option>
              <option>Mixed Use</option>
            </select>
          </div>
          <div class="form-row"><label class="form-label">Status</label>
            <select class="form-select" id="p-status">
              <option value="Available">🟢 Available</option>
              <option value="Negotiation">🟡 In Negotiation</option>
              <option value="On Hold">🟠 On Hold</option>
              <option value="Sold">⚫ Sold</option>
            </select>
          </div>
        </div>
        <div class="form-2col">
          <div class="form-row"><label class="form-label">Location / Address *</label>
            <input class="form-input" id="p-location" placeholder="e.g. Khed, Pune, Maharashtra">
          </div>
          <div class="form-row"><label class="form-label">Survey / Plot Number</label>
            <input class="form-input" id="p-survey" placeholder="e.g. Survey No. 123/1A">
          </div>
        </div>
        <div class="form-3col">
          <div class="form-row"><label class="form-label">Total Area *</label>
            <input class="form-input" id="p-area" placeholder="e.g. 5 Acres / 2000 sqft">
          </div>
          <div class="form-row"><label class="form-label">Asking Price *</label>
            <input class="form-input" id="p-price" placeholder="e.g. ₹ 45 Lakhs / Acre">
          </div>
          <div class="form-row"><label class="form-label">Price Per Unit</label>
            <input class="form-input" id="p-ppu" placeholder="e.g. ₹ 450/sqft">
          </div>
        </div>
        <div class="form-2col">
          <div class="form-row"><label class="form-label">Zone / Usage</label>
            <select class="form-select" id="p-zone">
              <option value="">Select zone</option>
              <option>Agricultural</option>
              <option>Residential</option>
              <option>Commercial</option>
              <option>Industrial</option>
              <option>Mixed Use</option>
              <option>Green Belt</option>
              <option>NA Plot (Non-Agricultural)</option>
              <option>SEZ</option>
            </select>
          </div>
          <div class="form-row"><label class="form-label">Facing / Vasthu</label>
            <select class="form-select" id="p-facing">
              <option value="">Select facing</option>
              <option>East Facing</option><option>West Facing</option>
              <option>North Facing</option><option>South Facing</option>
              <option>North-East</option><option>North-West</option>
              <option>South-East</option><option>South-West</option>
            </select>
          </div>
        </div>
        <div class="form-row"><label class="form-label">Key Features / Highlights</label>
          <textarea class="form-textarea" id="p-features" placeholder="Water source, road access, electricity, fencing, soil type, nearby landmarks…" style="min-height:60px"></textarea>
        </div>
        <div class="form-row"><label class="form-label">Property Description / Remarks</label>
          <textarea class="form-textarea" id="p-desc" placeholder="Detailed description, investment potential, access road details, legal status…"></textarea>
        </div>
      </div>

      <!-- SECTION: Supplier / Owner Details -->
      <div class="modal-section">
        <div class="modal-section-title">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          Supplier / Owner Details
        </div>
        <div class="form-2col">
          <div class="form-row"><label class="form-label">Supplier / Owner Name *</label>
            <input class="form-input" id="p-supplier-name" placeholder="e.g. Ramesh Patil">
          </div>
          <div class="form-row"><label class="form-label">Supplier Phone *</label>
            <input class="form-input" id="p-supplier-phone" placeholder="+91 98765 43210">
          </div>
        </div>
        <div class="form-2col">
          <div class="form-row"><label class="form-label">Supplier Email</label>
            <input class="form-input" id="p-supplier-email" placeholder="owner@email.com">
          </div>
          <div class="form-row"><label class="form-label">Supplier Type</label>
            <select class="form-select" id="p-supplier-type">
              <option value="Direct Owner">Direct Owner</option>
              <option value="Broker / Agent">Broker / Agent</option>
              <option value="Builder / Developer">Builder / Developer</option>
              <option value="Bank / NPA">Bank / NPA</option>
              <option value="Government">Government</option>
              <option value="Investor">Investor</option>
            </select>
          </div>
        </div>
        <div class="form-2col">
          <div class="form-row"><label class="form-label">Commission / Brokerage</label>
            <input class="form-input" id="p-commission" placeholder="e.g. 1% or ₹50,000 fixed">
          </div>
          <div class="form-row"><label class="form-label">Negotiable?</label>
            <select class="form-select" id="p-negotiable">
              <option value="Yes">Yes — Price Negotiable</option>
              <option value="No">No — Fixed Price</option>
              <option value="Partially">Partially Negotiable</option>
            </select>
          </div>
        </div>
      </div>

      <!-- SECTION: Legal & Documents -->
      <div class="modal-section">
        <div class="modal-section-title">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          Legal & Documents
        </div>
        <div class="form-3col">
          <div class="form-row"><label class="form-label">Title / Ownership</label>
            <select class="form-select" id="p-title-status">
              <option value="">Unknown</option>
              <option>Clear Title</option>
              <option>Disputed</option>
              <option>Joint Ownership</option>
              <option>Under Litigation</option>
              <option>NRI Owned</option>
            </select>
          </div>
          <div class="form-row"><label class="form-label">7/12 Extract</label>
            <select class="form-select" id="p-712">
              <option value="">Not checked</option>
              <option>Available</option>
              <option>Not Available</option>
              <option>Under Process</option>
            </select>
          </div>
          <div class="form-row"><label class="form-label">NA Order / Permission</label>
            <select class="form-select" id="p-na">
              <option value="">Not applicable</option>
              <option>Available</option>
              <option>Applied — Pending</option>
              <option>Required</option>
              <option>Not Required</option>
            </select>
          </div>
        </div>
        <div class="form-row"><label class="form-label">Additional Legal Notes</label>
          <textarea class="form-textarea" id="p-legal" placeholder="Any encumbrance, mortgage, court orders, disputed boundaries, pending dues…" style="min-height:60px"></textarea>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closePropModal()">Cancel</button>
      <button class="btn-save" id="savePropBtn" onclick="saveProperty()">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
        Save Property
      </button>
    </div>
  </div>
</div>

<!-- ════════ PROPERTY DETAIL VIEW MODAL ════════ -->
<div class="modal-overlay" id="propDetailOverlay" onclick="if(event.target===this)closePropDetail()">
  <div class="modal wide">
    <div class="modal-header">
      <h3 id="propDetailTitle">Property Details</h3>
      <div class="modal-close" onclick="closePropDetail()">✕</div>
    </div>
    <div class="modal-body" id="propDetailBody"></div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closePropDetail()">Close</button>
      <button class="btn-save" id="propDetailEditBtn" onclick="">
        ✏️ Edit Property
      </button>
    </div>
  </div>
</div>

<!-- ════════ ADD VIP CONTACT MODAL ════════ -->
<div class="modal-overlay" id="vipAddModalOverlay" onclick="if(event.target===this)closeVipAddModal()">
  <div class="modal">
    <div class="modal-header">
      <h3 id="vipAddModalTitle" style="color:#25d366">Add VIP Contact</h3>
      <div class="modal-close" onclick="closeVipAddModal()">✕</div>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editVipId">
      <div style="background:#25d36610;border:1px solid #25d36625;border-radius:8px;padding:10px 12px;margin-bottom:16px;font-size:12px;color:var(--text2);line-height:1.6">
        💡 VIP contacts receive WhatsApp alerts whenever a new lead is added to the CRM. Add your top clients, investors, co-agents, or team members here.
      </div>
      <div class="form-2col">
        <div class="form-row"><label class="form-label">Contact Name *</label><input class="form-input" id="vc-name" placeholder="e.g. Priya Mehta"></div>
        <div class="form-row"><label class="form-label">WhatsApp Number *</label><input class="form-input" id="vc-phone" placeholder="+91 98800 12345"></div>
      </div>
      <div class="form-2col">
        <div class="form-row"><label class="form-label">Contact Type</label>
          <select class="form-select" id="vc-type">
            <option value="Investor">💼 Investor</option>
            <option value="Co-Agent">🤝 Co-Agent / Broker</option>
            <option value="VIP Client">⭐ VIP Client</option>
            <option value="Team Member">👥 Team Member</option>
            <option value="Partner">🔗 Business Partner</option>
          </select>
        </div>
        <div class="form-row"><label class="form-label">Notes</label><input class="form-input" id="vc-notes" placeholder="e.g. Interested in 2BHK Pune"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeVipAddModal()">Cancel</button>
      <button class="btn-save" id="saveVipBtn" onclick="saveVipContact()" style="background:#25d366;color:#000">
        💚 Save Contact
      </button>
    </div>
  </div>
</div>

<!-- ════════ WHATSAPP BROADCAST MODAL ════════ -->
<div class="modal-overlay" id="waBroadcastOverlay" onclick="if(event.target===this)closeWaBroadcast()">
  <div class="wa-modal">
    <div class="wa-modal-header">
      <div class="wa-modal-icon">💬</div>
      <div class="wa-modal-titles">
        <h3>WhatsApp Broadcast</h3>
        <p id="waBcSubtitle">Send new lead details to VIP contacts</p>
      </div>
      <div class="modal-close" onclick="closeWaBroadcast()" style="margin-left:auto">✕</div>
    </div>
    <div class="modal-body">
      <!-- Lead Banner -->
      <div class="wa-lead-banner" id="waBcLeadBanner">
        <div class="wa-lead-av" id="waBcLeadAv">?</div>
        <div class="wa-lead-details">
          <div class="wa-lead-name" id="waBcLeadName">New Lead</div>
          <div class="wa-lead-meta" id="waBcLeadMeta">Loading lead details…</div>
        </div>
        <span class="wa-new-badge">🆕 New Lead</span>
      </div>

      <!-- Message Preview / Edit -->
      <div class="wa-msg-preview">
        <div class="wa-msg-preview-header">
          <span>Message Preview</span>
          <span class="wa-msg-edit-btn" onclick="toggleWaMsgEdit()">✏️ Edit</span>
        </div>
        <div class="wa-msg-body" id="waMsgBody">Loading message…</div>
      </div>

      <!-- Contacts -->
      <div class="wa-contacts-header">
        <span>Send to VIP Contacts</span>
        <span class="wa-contacts-count" id="waBcContactsCount">0 contacts</span>
      </div>
      <div id="waBcContactsList">
        <div class="loading"><div class="spinner"></div>Loading contacts…</div>
      </div>
    </div>
    <div class="wa-modal-footer">
      <span class="wa-sent-count" id="waBcSentCount">0 sent</span>
      <div style="display:flex;gap:8px">
        <button class="btn-cancel" onclick="closeWaBroadcast()">Skip</button>
        <button class="wa-send-all-btn" onclick="sendToAllVips()">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          Send to All VIPs
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ════════ PICK LEAD FOR BROADCAST ════════ -->
<div class="modal-overlay" id="pickLeadOverlay" onclick="if(event.target===this)document.getElementById('pickLeadOverlay').classList.remove('open')">
  <div class="modal">
    <div class="modal-header">
      <h3>Select Lead to Broadcast</h3>
      <div class="modal-close" onclick="document.getElementById('pickLeadOverlay').classList.remove('open')">✕</div>
    </div>
    <div class="modal-body" style="padding:12px">
      <input class="form-input" id="pickLeadSearch" placeholder="Search lead by name…" oninput="renderPickLeadList(this.value)" style="margin-bottom:12px">
      <div id="pickLeadList" style="max-height:340px;overflow-y:auto"></div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <span id="toastIcon">✨</span>
  <span id="toastMsg">Done!</span>
</div>

<script>
// ════════════════════════════════════════════
// STATE
// ════════════════════════════════════════════
let _leads = [];
let _followups = [];
let _properties = [];
let _currentFilter = 'all';
let _currentFuType = 'all';
let _currentPropFilter = 'all';
let _propViewMode = 'grid'; // 'grid' or 'table'
let _editingLeadId = null;
let _editingFuId = null;
let _editingPropId = null;
let _dbConnected = false;

// ════════════════════════════════════════════
// INIT
// ════════════════════════════════════════════
function initApp() {
  updateDate();
  buildMiniCal();

  if (window._dbReady && window._db) {
    setDbStatus(true, 'Connected');
    _dbConnected = true;
    loadLeadsFromDB();
    loadFollowUpsFromDB();
    loadPropertiesFromDB();
    loadVipContactsFromDB();
  } else {
    window.addEventListener('dbReady', () => {
      setDbStatus(true, 'Connected');
      _dbConnected = true;
      loadLeadsFromDB();
      loadFollowUpsFromDB();
      loadPropertiesFromDB();
    }, { once: true });
    setTimeout(() => {
      if (!_dbConnected) {
        setDbStatus(false, 'Connection failed');
        showToast('⚠️ Firebase connection failed. Check network.', 'error');
        renderLeads(); renderFollowUps(); renderDashboard(); renderProperties();
      }
    }, 8000);
  }
}

// ════════════════════════════════════════════
// FIRESTORE — LEADS
// ════════════════════════════════════════════
async function loadLeadsFromDB() {
  try {
    const { collection, onSnapshot, orderBy, query } = window._firebase;
    const q = query(collection(window._db, 'leads'), orderBy('createdAt', 'desc'));
    onSnapshot(q, (snapshot) => {
      _leads = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      renderLeads(); renderDashboard(); updateNavCounts();
    }, (err) => { console.error(err); setDbStatus(false, 'Read error'); });
  } catch(e) { showToast('❌ Could not load leads: ' + e.message, 'error'); }
}
async function addLeadToDB(data) { const { collection, addDoc, serverTimestamp } = window._firebase; await addDoc(collection(window._db, 'leads'), { ...data, createdAt: serverTimestamp() }); }
async function updateLeadInDB(id, data) { const { doc, updateDoc } = window._firebase; await updateDoc(doc(window._db, 'leads', id), data); }
async function deleteLeadFromDB(id) { const { doc, deleteDoc } = window._firebase; await deleteDoc(doc(window._db, 'leads', id)); }

// ════════════════════════════════════════════
// FIRESTORE — FOLLOW-UPS
// ════════════════════════════════════════════
async function loadFollowUpsFromDB() {
  try {
    const { collection, onSnapshot, orderBy, query } = window._firebase;
    const q = query(collection(window._db, 'followups'), orderBy('date', 'asc'));
    onSnapshot(q, (snapshot) => {
      _followups = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      renderFollowUps(); renderDashboard(); updateNavCounts();
    });
  } catch(e) { showToast('❌ Could not load follow-ups: ' + e.message, 'error'); }
}
async function addFollowUpToDB(data) { const { collection, addDoc, serverTimestamp } = window._firebase; await addDoc(collection(window._db, 'followups'), { ...data, createdAt: serverTimestamp() }); }
async function updateFollowUpInDB(id, data) { const { doc, updateDoc } = window._firebase; await updateDoc(doc(window._db, 'followups', id), data); }
async function deleteFollowUpFromDB(id) { const { doc, deleteDoc } = window._firebase; await deleteDoc(doc(window._db, 'followups', id)); }

// ════════════════════════════════════════════
// FIRESTORE — PROPERTIES
// ════════════════════════════════════════════
async function loadPropertiesFromDB() {
  try {
    const { collection, onSnapshot, orderBy, query } = window._firebase;
    const q = query(collection(window._db, 'properties'), orderBy('createdAt', 'desc'));
    onSnapshot(q, (snapshot) => {
      _properties = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      renderProperties(); renderDashboard(); updateNavCounts();
    }, (err) => { console.error(err); });
  } catch(e) { showToast('❌ Could not load properties: ' + e.message, 'error'); }
}
async function addPropertyToDB(data) { const { collection, addDoc, serverTimestamp } = window._firebase; await addDoc(collection(window._db, 'properties'), { ...data, createdAt: serverTimestamp() }); }
async function updatePropertyInDB(id, data) { const { doc, updateDoc } = window._firebase; await updateDoc(doc(window._db, 'properties', id), data); }
async function deletePropertyFromDB(id) { const { doc, deleteDoc } = window._firebase; await deleteDoc(doc(window._db, 'properties', id)); }

// ════════════════════════════════════════════
// RENDER — LEADS TABLE
// ════════════════════════════════════════════
function renderLeads(filter) {
  if (filter !== undefined) _currentFilter = filter;
  const tbody = document.getElementById('leadsTableBody');
  let list = _leads;
  if (_currentFilter !== 'all') list = list.filter(l => l.stage === _currentFilter);

  const counts = {};
  _leads.forEach(l => { counts[l.stage] = (counts[l.stage] || 0) + 1; });
  document.getElementById('chip-all').textContent = _leads.length;
  ['new','contacted','site','nego','closed','lost'].forEach((k, i) => {
    const stages = ['New','Contacted','Site Visit','Negotiation','Closed','Lost'];
    const el = document.getElementById('chip-' + k);
    if(el) el.textContent = counts[stages[i]] || 0;
  });
  document.getElementById('leads-subtitle').textContent =
    `${_leads.length} total leads · ${counts['New']||0} new · ${counts['Negotiation']||0} in negotiation`;

  if (list.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9"><div class="empty-state"><div class="empty-state-icon">👥</div><h3>${_currentFilter==='all'?'No leads yet':'No '+_currentFilter+' leads'}</h3><p>${_currentFilter==='all'?'Click "Add Lead" to add your first lead.':'No leads in this stage yet.'}</p></div></td></tr>`;
    return;
  }

  tbody.innerHTML = list.map(l => {
    const pillClass = {'New':'pill-new','Contacted':'pill-contacted','Site Visit':'pill-site','Negotiation':'pill-nego','Closed':'pill-closed','Lost':'pill-lost'}[l.stage]||'pill-new';
    const priorityBadge = l.priority==='Hot'?'<span class="tag tag-hot">🔥 Hot</span>':l.priority==='VIP'?'<span class="tag tag-vip">⭐ VIP</span>':l.priority==='Warm'?'<span class="tag tag-warm">Warm</span>':l.priority==='Cold'?'<span class="tag tag-cold">Cold</span>':'—';
    const date = l.createdAt?.toDate ? l.createdAt.toDate().toLocaleDateString('en-IN',{day:'2-digit',month:'short'}) : 'Just now';
    return `<tr>
      <td><span class="td-name">${esc(l.name)}</span></td>
      <td><span class="td-phone">${esc(l.phone||'—')}</span></td>
      <td><span class="td-budget">${esc(l.budget||'—')}</span></td>
      <td>${esc(l.location||'—')}</td>
      <td>${esc(l.source||'—')}</td>
      <td><span class="status-pill ${pillClass}">${l.stage}</span></td>
      <td>${priorityBadge}</td>
      <td style="font-size:11px;color:var(--text3)">${date}</td>
      <td><div class="td-actions">
        <button class="row-btn" onclick="openLeadModal('${l.id}')">✏️ Edit</button>
        <button class="row-btn" onclick="openFollowUpModal(null,'${l.id}')">📅 FU</button>
        <button class="row-btn" style="background:#25d36615;border-color:#25d36630;color:#25d366" onclick="openWaBroadcast(_leads.find(function(l){return l.id==='${l.id}';})||{name:'${esc(l.name)}',phone:'${esc(l.phone||'')}',budget:'${esc(l.budget||'')}',location:'${esc(l.location||'')}'})" title="Broadcast to VIPs">💬 VIP</button>
        <button class="row-btn del" onclick="confirmDeleteLead('${l.id}','${esc(l.name)}')">🗑</button>
      </div></td>
    </tr>`;
  }).join('');
}

// ════════════════════════════════════════════
// RENDER — FOLLOW-UPS
// ════════════════════════════════════════════
function renderFollowUps(type) {
  if (type !== undefined) _currentFuType = type;
  const container = document.getElementById('fuMainArea');
  const today = new Date().toISOString().split('T')[0];
  let list = _followups.filter(f => f.status !== 'done');
  if (_currentFuType !== 'all') list = list.filter(f => f.type === _currentFuType);
  document.getElementById('fu-subtitle').textContent = `${list.filter(f=>f.date===today).length} due today · ${list.length} pending total`;

  if (list.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">📅</div><h3>No follow-ups yet</h3><p>Add a follow-up reminder for a lead to stay on top of every client.</p><button class="btn-save" onclick="openFollowUpModal()">+ Add Follow-up</button></div>`;
    return;
  }
  const groups = {};
  list.forEach(f => { const d=f.date||'No date'; if(!groups[d])groups[d]=[]; groups[d].push(f); });
  const sortedDates = Object.keys(groups).sort();
  container.innerHTML = sortedDates.map(date => {
    const label = date===today?'🔴 Today — '+formatDate(date):date<today?'⚠️ Overdue — '+formatDate(date):formatDate(date);
    return `<div style="font-size:12px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin:${date===sortedDates[0]?'0':'16px'} 0 12px">${label}</div>${groups[date].map((f,i)=>renderFuCard(f,i)).join('')}`;
  }).join('');
}

function renderFuCard(f, idx) {
  const lead = _leads.find(l => l.id === f.leadId);
  const leadName = lead ? lead.name : (f.leadName || 'Unknown Lead');
  const initials = leadName.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
  const typeIcon = {Call:'📞',WhatsApp:'💬','Site Visit':'🏠',Document:'📄',Email:'📧',Meeting:'🤝'}[f.type]||'📋';
  const urgentClass = f.priority==='Urgent'?'tag-hot':f.priority==='High'?'tag-warm':'';
  const timeStyle = f.priority==='Urgent'?'background:var(--red-dim);color:var(--red)':'background:var(--orange-dim);color:var(--orange)';
  return `<div class="fu-card" style="animation-delay:${idx*.05}s">
    <div class="fu-card-top">
      <div class="fu-card-avatar">${initials}</div>
      <div class="fu-card-info"><div class="fu-card-name">${esc(leadName)}</div><div class="fu-card-sub">${lead?esc(lead.budget||'')+(lead.location?' · '+lead.location:''):'Lead not found'}</div></div>
      <div class="fu-card-badges">
        ${urgentClass?`<span class="tag ${urgentClass}">${f.priority}</span>`:''}
        ${f.time?`<span style="font-size:11px;font-weight:600;padding:3px 8px;border-radius:20px;${timeStyle}">${f.time}</span>`:''}
      </div>
    </div>
    <div class="fu-body">${typeIcon} <strong>${f.type}</strong> — ${esc(f.notes||'No notes')}</div>
    <div class="fu-footer">
      <button class="fu-action-btn primary" onclick="markFuDone('${f.id}')">✓ Done</button>
      <button class="fu-action-btn" onclick="openFollowUpModal('${f.id}')">✏️ Edit</button>
      <button class="fu-action-btn danger" onclick="confirmDeleteFu('${f.id}')">🗑 Delete</button>
    </div>
  </div>`;
}

// ════════════════════════════════════════════
// RENDER — PROPERTIES
// ════════════════════════════════════════════
function getPropIcon(type) {
  const icons = {
    'Agricultural Land':'🌾','Farm Land':'🌻','Residential Plot':'🏡',
    'Commercial Plot':'🏢','Apartment':'🏬','Villa / Bungalow':'🏠',
    'Industrial Land':'🏭','Warehouse / Godown':'📦','Office Space':'💼','Mixed Use':'🏙️'
  };
  return icons[type] || '🏗️';
}
function getPropStatusClass(status) {
  return {Available:'prop-avail',Negotiation:'prop-nego','On Hold':'prop-hold',Sold:'prop-sold'}[status]||'prop-avail';
}

function renderProperties(filter) {
  if (filter !== undefined) _currentPropFilter = filter;
  const typeFilter = document.getElementById('propTypeFilter')?.value || '';

  let list = _properties;
  if (_currentPropFilter !== 'all') list = list.filter(p => p.status === _currentPropFilter);
  if (typeFilter) list = list.filter(p => p.type === typeFilter);

  // Update chips
  const counts = {};
  _properties.forEach(p => { counts[p.status] = (counts[p.status]||0)+1; });
  document.getElementById('pchip-all').textContent = _properties.length;
  document.getElementById('pchip-avail').textContent = counts['Available']||0;
  document.getElementById('pchip-nego').textContent = counts['Negotiation']||0;
  document.getElementById('pchip-hold').textContent = counts['On Hold']||0;
  document.getElementById('pchip-sold').textContent = counts['Sold']||0;
  document.getElementById('props-subtitle').textContent =
    `${_properties.length} listings · ${counts['Available']||0} available · ${counts['Negotiation']||0} in negotiation`;

  if (_propViewMode === 'grid') renderPropsGrid(list);
  else renderPropsTable(list);
}

function renderPropsGrid(list) {
  const grid = document.getElementById('propsGrid');
  if (list.length === 0) {
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1">
      <div class="empty-state-icon">🏗️</div>
      <h3>No properties listed yet</h3>
      <p>Click "Add Property" to add your first supplier land or property listing.</p>
      <button class="btn-save" onclick="openPropertyModal()">+ Add Property</button>
    </div>`;
    return;
  }
  grid.innerHTML = list.map((p, i) => {
    const icon = getPropIcon(p.type);
    const statusClass = getPropStatusClass(p.status);
    const supplierInitials = (p.supplierName||'?').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
    return `<div class="prop-card" style="animation-delay:${i*0.05}s" onclick="viewProperty('${p.id}')">
      <div class="prop-card-img">
        <div class="prop-card-img-bg" style="background:radial-gradient(circle at 30% 50%,var(--purple),transparent 70%)"></div>
        <div class="prop-card-img-icon">${icon}</div>
        <div class="prop-card-img-overlay"></div>
        <div class="prop-card-img-badges">
          <span class="status-pill ${statusClass}">${p.status||'Available'}</span>
          ${p.zone?`<span class="tag" style="background:var(--bg4);color:var(--text2)">${p.zone}</span>`:''}
        </div>
        <div class="prop-card-img-price">${esc(p.price||'Price TBD')}</div>
      </div>
      <div class="prop-card-body">
        <div class="prop-card-title" title="${esc(p.title)}">${esc(p.title||'Untitled Property')}</div>
        <div class="prop-card-sub">
          <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="color:var(--text3)"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
          ${esc(p.location||'Location TBD')}
        </div>
        <div class="prop-meta-row">
          ${p.type?`<div class="prop-meta">🏷️ ${esc(p.type)}</div>`:''}
          ${p.area?`<div class="prop-meta">📐 ${esc(p.area)}</div>`:''}
          ${p.facing?`<div class="prop-meta">🧭 ${esc(p.facing)}</div>`:''}
          ${p.negotiable?`<div class="prop-meta" style="${p.negotiable==='Yes'?'color:var(--green)':''}">${p.negotiable==='Yes'?'✓ Negotiable':p.negotiable==='No'?'⚑ Fixed':'≈ Partial'}</div>`:''}
        </div>
        <div class="prop-supplier-row">
          <div class="prop-supplier-av">${supplierInitials}</div>
          <div class="prop-supplier-info">
            <div class="prop-supplier-name">${esc(p.supplierName||'No supplier')}</div>
            <div class="prop-supplier-role">${esc(p.supplierType||'Owner')} ${p.supplierPhone?'· '+p.supplierPhone:''}</div>
          </div>
        </div>
        <div class="prop-card-actions" style="margin-top:10px">
          <button class="prop-action-btn" onclick="event.stopPropagation();openPropertyModal('${p.id}')">✏️ Edit</button>
          <button class="prop-action-btn del" onclick="event.stopPropagation();confirmDeleteProp('${p.id}','${esc(p.title||'')}')">🗑 Delete</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function renderPropsTable(list) {
  const tbody = document.getElementById('propsTableBody');
  if (list.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9"><div class="empty-state"><div class="empty-state-icon">🏗️</div><h3>No properties</h3></div></td></tr>`;
    return;
  }
  tbody.innerHTML = list.map(p => {
    const statusClass = getPropStatusClass(p.status);
    const date = p.createdAt?.toDate ? p.createdAt.toDate().toLocaleDateString('en-IN',{day:'2-digit',month:'short'}) : 'Just now';
    return `<tr onclick="viewProperty('${p.id}')">
      <td><span class="td-name">${esc(p.title||'—')}</span></td>
      <td>${esc(p.type||'—')}</td>
      <td>${esc(p.location||'—')}</td>
      <td>${esc(p.area||'—')}</td>
      <td><span class="td-budget">${esc(p.price||'—')}</span></td>
      <td>${esc(p.supplierName||'—')}</td>
      <td><span class="status-pill ${statusClass}">${p.status||'Available'}</span></td>
      <td style="font-size:11px;color:var(--text3)">${date}</td>
      <td><div class="td-actions">
        <button class="row-btn" onclick="event.stopPropagation();openPropertyModal('${p.id}')">✏️ Edit</button>
        <button class="row-btn del" onclick="event.stopPropagation();confirmDeleteProp('${p.id}','${esc(p.title||'')}')">🗑</button>
      </div></td>
    </tr>`;
  }).join('');
}

// ════════════════════════════════════════════
// RENDER — DASHBOARD
// ════════════════════════════════════════════
function renderDashboard() {
  const today = new Date().toISOString().split('T')[0];
  const hot = _leads.filter(l=>l.priority==='Hot'||l.priority==='VIP').length;
  const closed = _leads.filter(l=>l.stage==='Closed').length;
  const todayFu = _followups.filter(f=>f.date===today&&f.status!=='done').length;
  const availProps = _properties.filter(p=>p.status==='Available').length;

  document.getElementById('dash-total').textContent = _leads.length;
  document.getElementById('dash-props').textContent = _properties.length;
  document.getElementById('dash-today-fu').textContent = todayFu;
  document.getElementById('dash-closed').textContent = closed;
  document.getElementById('stat-total').textContent = _leads.length;
  document.getElementById('stat-closed').textContent = closed;
  document.getElementById('stat-hot').textContent = hot;
  document.getElementById('todayFuBadge').textContent = todayFu;

  const stages = ['New','Site Visit','Negotiation','Closed'];
  const stageKeys = ['new','site','nego','closed'];
  stages.forEach((s,i) => {
    const filtered = _leads.filter(l=>l.stage===s);
    const key = stageKeys[i];
    const countEl = document.getElementById('pc-'+key);
    if(countEl) countEl.textContent = filtered.length+' lead'+(filtered.length!==1?'s':'');
    const listEl = document.getElementById('pc-leads-'+key);
    if(listEl) {
      listEl.innerHTML = filtered.length===0
        ? `<div style="font-size:11px;color:var(--text3);padding:8px;text-align:center">No leads</div>`
        : filtered.slice(0,4).map(l=>`<div class="lead-mini" onclick="setView('leads')"><div class="lm-name">${esc(l.name)}</div><div class="lm-prop">${esc(l.location||'')}</div><div class="lm-budget">${esc(l.budget||'—')}</div></div>`).join('');
    }
  });

  const todayList = _followups.filter(f=>f.date===today&&f.status!=='done');
  const dashFuList = document.getElementById('dash-fu-list');
  document.getElementById('dash-fu-subtitle').textContent = todayFu+' pending today';
  dashFuList.innerHTML = todayList.length===0
    ? `<div style="padding:16px;text-align:center;font-size:12px;color:var(--text3)">🎉 No follow-ups due today!</div>`
    : todayList.slice(0,4).map(f=>{
        const lead=_leads.find(l=>l.id===f.leadId);
        const name=lead?lead.name:(f.leadName||'Unknown');
        const initials=name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
        return `<div class="fu-dash-item" onclick="setView('followups')">
          <div class="fu-dash-av">${initials}</div>
          <div class="fu-dash-info"><div class="fu-dash-name">${esc(name)}</div><div class="fu-dash-note">${f.type}: ${esc(f.notes||'')}</div></div>
          <span class="fu-dash-time ${f.priority==='Urgent'?'urgent':'today'}">${f.time||'Today'}</span>
        </div>`;
      }).join('');
}

// ════════════════════════════════════════════
// SAVE — LEAD
// ════════════════════════════════════════════
async function saveLead() {
  const name = document.getElementById('f-name').value.trim();
  const phone = document.getElementById('f-phone').value.trim();
  if (!name||!phone) { showToast('⚠️ Name and phone are required', 'error'); return; }
  const data = { name, phone, email:document.getElementById('f-email').value.trim(), budget:document.getElementById('f-budget').value.trim(), proptype:document.getElementById('f-proptype').value, location:document.getElementById('f-location').value.trim(), source:document.getElementById('f-source').value, stage:document.getElementById('f-stage').value||'New', priority:document.getElementById('f-priority').value||'Normal', wa:document.getElementById('f-wa').value.trim(), notes:document.getElementById('f-notes').value.trim() };
  const btn = document.getElementById('saveLeadBtn');
  btn.disabled=true; btn.textContent='Saving…';
  try {
    if(_editingLeadId) { await updateLeadInDB(_editingLeadId,data); showToast('✅ Lead updated!','success'); }
    else { await addLeadToDB(data); showToast('✅ Lead saved!','success'); closeLeadModal(); if(_vipContacts.length>0){setTimeout(function(){openWaBroadcast({...data,id:'new'});},400);} return; }
    closeLeadModal();
  } catch(e) { showToast('❌ Error: '+e.message,'error'); }
  finally { btn.disabled=false; btn.innerHTML='<svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg> Save Lead'; }
}

async function quickAddLead() {
  const name=document.getElementById('quick-name').value.trim();
  const phone=document.getElementById('quick-phone').value.trim();
  const budget=document.getElementById('quick-budget').value.trim();
  if(!name||!phone){showToast('⚠️ Name and phone required','error');return;}
  try {
    await addLeadToDB({name,phone,budget,stage:'New',priority:'Normal',email:'',location:'',source:'',notes:''});
    document.getElementById('quick-name').value='';
    document.getElementById('quick-phone').value='';
    document.getElementById('quick-budget').value='';
    showToast('✅ Lead added!','success');
  } catch(e){showToast('❌ Error: '+e.message,'error');}
}

// ════════════════════════════════════════════
// SAVE — FOLLOW-UP
// ════════════════════════════════════════════
async function saveFollowUp() {
  const leadId=document.getElementById('fu-leadId').value;
  const date=document.getElementById('fu-date').value;
  const notes=document.getElementById('fu-notes').value.trim();
  if(!leadId){showToast('⚠️ Please select a lead','error');return;}
  if(!date){showToast('⚠️ Please select a date','error');return;}
  if(!notes){showToast('⚠️ Please add a note','error');return;}
  const lead=_leads.find(l=>l.id===leadId);
  const data={leadId,leadName:lead?lead.name:'',type:document.getElementById('fu-type').value,date,time:document.getElementById('fu-time').value,priority:document.getElementById('fu-priority').value,notes,status:'pending'};
  const btn=document.getElementById('saveFuBtn');
  btn.disabled=true; btn.textContent='Saving…';
  try {
    if(_editingFuId){await updateFollowUpInDB(_editingFuId,data);showToast('✅ Follow-up updated!','success');}
    else{await addFollowUpToDB(data);showToast('✅ Follow-up scheduled!','success');}
    closeFuModal();
  } catch(e){showToast('❌ Error: '+e.message,'error');}
  finally{btn.disabled=false;btn.innerHTML='<svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg> Save Follow-up';}
}

async function markFuDone(id) {
  try { await updateFollowUpInDB(id,{status:'done'}); showToast('✅ Marked as done!','success'); }
  catch(e){showToast('❌ Error: '+e.message,'error');}
}

// ════════════════════════════════════════════
// SAVE — PROPERTY
// ════════════════════════════════════════════
async function saveProperty() {
  const title = document.getElementById('p-title').value.trim();
  const type = document.getElementById('p-type').value;
  const location = document.getElementById('p-location').value.trim();
  const supplierName = document.getElementById('p-supplier-name').value.trim();
  const supplierPhone = document.getElementById('p-supplier-phone').value.trim();

  if(!title){showToast('⚠️ Property title is required','error');return;}
  if(!type){showToast('⚠️ Please select property type','error');return;}
  if(!location){showToast('⚠️ Location is required','error');return;}
  if(!supplierName||!supplierPhone){showToast('⚠️ Supplier name and phone are required','error');return;}

  const data = {
    title, type, location,
    survey: document.getElementById('p-survey').value.trim(),
    area: document.getElementById('p-area').value.trim(),
    price: document.getElementById('p-price').value.trim(),
    ppu: document.getElementById('p-ppu').value.trim(),
    zone: document.getElementById('p-zone').value,
    facing: document.getElementById('p-facing').value,
    status: document.getElementById('p-status').value || 'Available',
    features: document.getElementById('p-features').value.trim(),
    description: document.getElementById('p-desc').value.trim(),
    supplierName, supplierPhone,
    supplierEmail: document.getElementById('p-supplier-email').value.trim(),
    supplierType: document.getElementById('p-supplier-type').value,
    commission: document.getElementById('p-commission').value.trim(),
    negotiable: document.getElementById('p-negotiable').value,
    titleStatus: document.getElementById('p-title-status').value,
    doc712: document.getElementById('p-712').value,
    naOrder: document.getElementById('p-na').value,
    legalNotes: document.getElementById('p-legal').value.trim(),
  };

  const btn = document.getElementById('savePropBtn');
  btn.disabled=true; btn.textContent='Saving…';
  try {
    if(_editingPropId){ await updatePropertyInDB(_editingPropId, data); showToast('✅ Property updated!','success'); }
    else { await addPropertyToDB(data); showToast('✅ Property listed!','success'); }
    closePropModal();
  } catch(e){showToast('❌ Error: '+e.message,'error');}
  finally{btn.disabled=false; btn.innerHTML='<svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg> Save Property';}
}

// ════════════════════════════════════════════
// DELETE
// ════════════════════════════════════════════
function confirmDeleteLead(id,name){if(!confirm(`Delete lead "${name}"?`))return;deleteLeadFromDB(id).then(()=>showToast(`🗑 ${name} deleted`,'success')).catch(e=>showToast('❌ '+e.message,'error'));}
function confirmDeleteFu(id){if(!confirm('Delete this follow-up?'))return;deleteFollowUpFromDB(id).then(()=>showToast('🗑 Deleted','success')).catch(e=>showToast('❌ '+e.message,'error'));}
function confirmDeleteProp(id,title){if(!confirm(`Delete property "${title}"? This cannot be undone.`))return;deletePropertyFromDB(id).then(()=>showToast(`🗑 Property deleted`,'success')).catch(e=>showToast('❌ '+e.message,'error'));}

// ════════════════════════════════════════════
// VIEW PROPERTY DETAIL
// ════════════════════════════════════════════
function viewProperty(id) {
  const p = _properties.find(x=>x.id===id);
  if(!p) return;
  const icon = getPropIcon(p.type);
  const statusClass = getPropStatusClass(p.status);
  document.getElementById('propDetailTitle').textContent = p.title || 'Property Details';
  document.getElementById('propDetailEditBtn').onclick = () => { closePropDetail(); openPropertyModal(id); };
  document.getElementById('propDetailBody').innerHTML = `
    <div class="prop-detail-header">
      <div class="prop-detail-icon">${icon}</div>
      <div class="prop-detail-meta">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
          <span class="status-pill ${statusClass}">${p.status||'Available'}</span>
          ${p.type?`<span class="tag" style="background:var(--bg4);color:var(--text2)">${p.type}</span>`:''}
          ${p.zone?`<span class="tag" style="background:var(--teal-dim);color:var(--teal)">${p.zone}</span>`:''}
        </div>
        <div class="prop-detail-title">${esc(p.title)}</div>
        <div class="prop-detail-loc">📍 ${esc(p.location)} ${p.survey?'· '+p.survey:''}</div>
        <div class="prop-detail-price">${esc(p.price||'Price not set')} ${p.ppu?`<span style="font-size:13px;color:var(--text2);font-family:'DM Sans'">· ${esc(p.ppu)}</span>`:''}</div>
      </div>
    </div>

    <div class="prop-info-grid">
      <div class="prop-info-item"><div class="prop-info-label">Area / Size</div><div class="prop-info-value">${esc(p.area||'—')}</div></div>
      <div class="prop-info-item"><div class="prop-info-label">Facing</div><div class="prop-info-value">${esc(p.facing||'—')}</div></div>
      <div class="prop-info-item"><div class="prop-info-label">Price Negotiable</div><div class="prop-info-value" style="color:${p.negotiable==='Yes'?'var(--green)':'var(--text)'}">${esc(p.negotiable||'—')}</div></div>
      <div class="prop-info-item"><div class="prop-info-label">Title Status</div><div class="prop-info-value">${esc(p.titleStatus||'—')}</div></div>
      <div class="prop-info-item"><div class="prop-info-label">7/12 Extract</div><div class="prop-info-value">${esc(p.doc712||'—')}</div></div>
      <div class="prop-info-item"><div class="prop-info-label">NA Order</div><div class="prop-info-value">${esc(p.naOrder||'—')}</div></div>
    </div>

    ${p.features?`<div style="margin-bottom:14px"><div style="font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;margin-bottom:6px">Key Features</div><div class="fu-body">${esc(p.features)}</div></div>`:''}
    ${p.description?`<div style="margin-bottom:14px"><div style="font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;margin-bottom:6px">Description</div><div class="fu-body">${esc(p.description)}</div></div>`:''}

    <div style="background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:10px;display:flex;align-items:center;gap:6px">👤 Supplier / Owner Details</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><div style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;margin-bottom:3px">Name</div><div style="font-size:13px;font-weight:600;color:var(--text)">${esc(p.supplierName||'—')}</div></div>
        <div><div style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;margin-bottom:3px">Phone</div><div style="font-size:13px;font-family:'JetBrains Mono',monospace">${esc(p.supplierPhone||'—')}</div></div>
        <div><div style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;margin-bottom:3px">Email</div><div style="font-size:13px;color:var(--text)">${esc(p.supplierEmail||'—')}</div></div>
        <div><div style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;margin-bottom:3px">Type</div><div style="font-size:13px;color:var(--text)">${esc(p.supplierType||'—')}</div></div>
        <div><div style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;margin-bottom:3px">Commission</div><div style="font-size:13px;color:var(--gold);font-weight:600">${esc(p.commission||'—')}</div></div>
      </div>
    </div>

    ${p.legalNotes?`<div><div style="font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;margin-bottom:6px">⚖️ Legal Notes</div><div class="fu-body" style="border:1px solid rgba(224,85,85,.15)">${esc(p.legalNotes)}</div></div>`:''}
  `;
  document.getElementById('propDetailOverlay').classList.add('open');
}
function closePropDetail(){document.getElementById('propDetailOverlay').classList.remove('open');}

// ════════════════════════════════════════════
// MODAL HELPERS
// ════════════════════════════════════════════
function openLeadModal(leadId) {
  _editingLeadId = leadId||null;
  document.getElementById('leadModalTitle').textContent = leadId?'Edit Lead':'Add New Lead';
  const fields=['name','phone','email','budget','proptype','location','source','stage','priority','wa','notes'];
  fields.forEach(f=>{const el=document.getElementById('f-'+f);if(el)el.value='';});
  if(leadId){const lead=_leads.find(l=>l.id===leadId);if(lead)fields.forEach(f=>{const el=document.getElementById('f-'+f);if(el&&lead[f]!==undefined)el.value=lead[f];});}
  document.getElementById('leadModalOverlay').classList.add('open');
}
function closeLeadModal(){document.getElementById('leadModalOverlay').classList.remove('open');_editingLeadId=null;}

function openFollowUpModal(fuId, presetLeadId) {
  _editingFuId=fuId||null;
  document.getElementById('fuModalTitle').textContent=fuId?'Edit Follow-up':'Add Follow-up';
  const sel=document.getElementById('fu-leadId');
  sel.innerHTML='<option value="">Select a lead</option>'+_leads.map(l=>`<option value="${l.id}">${esc(l.name)} ${l.phone?'('+l.phone+')':''}</option>`).join('');
  document.getElementById('fu-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('fu-time').value='10:00';
  document.getElementById('fu-notes').value='';
  if(presetLeadId)document.getElementById('fu-leadId').value=presetLeadId;
  if(fuId){const fu=_followups.find(f=>f.id===fuId);if(fu){document.getElementById('fu-leadId').value=fu.leadId||'';document.getElementById('fu-type').value=fu.type||'Call';document.getElementById('fu-date').value=fu.date||'';document.getElementById('fu-time').value=fu.time||'10:00';document.getElementById('fu-priority').value=fu.priority||'Normal';document.getElementById('fu-notes').value=fu.notes||'';}}
  document.getElementById('fuModalOverlay').classList.add('open');
}
function closeFuModal(){document.getElementById('fuModalOverlay').classList.remove('open');_editingFuId=null;}

function openPropertyModal(propId) {
  _editingPropId = propId||null;
  document.getElementById('propModalTitle').textContent = propId?'Edit Property':'Add Property Listing';
  const fields=['title','type','location','survey','area','price','ppu','zone','facing','status','features','desc','supplier-name','supplier-phone','supplier-email','supplier-type','commission','negotiable','title-status','712','na','legal'];
  fields.forEach(f=>{const el=document.getElementById('p-'+f);if(el)el.value='';});
  document.getElementById('p-status').value='Available';
  document.getElementById('p-negotiable').value='Yes';
  document.getElementById('p-supplier-type').value='Direct Owner';
  if(propId){
    const p=_properties.find(x=>x.id===propId);
    if(p){
      const map={title:'title',type:'type',location:'location',survey:'survey',area:'area',price:'price',ppu:'ppu',zone:'zone',facing:'facing',status:'status',features:'features',description:'desc',supplierName:'supplier-name',supplierPhone:'supplier-phone',supplierEmail:'supplier-email',supplierType:'supplier-type',commission:'commission',negotiable:'negotiable',titleStatus:'title-status',doc712:'712',naOrder:'na',legalNotes:'legal'};
      Object.entries(map).forEach(([key,fieldId])=>{const el=document.getElementById('p-'+fieldId);if(el&&p[key]!==undefined)el.value=p[key];});
    }
  }
  document.getElementById('propModalOverlay').classList.add('open');
}
function closePropModal(){document.getElementById('propModalOverlay').classList.remove('open');_editingPropId=null;}

// ════════════════════════════════════════════
// VIEW MODE TOGGLE (grid/table)
// ════════════════════════════════════════════
function setPropView(mode) {
  _propViewMode = mode;
  document.getElementById('propsGridView').style.display = mode==='grid'?'block':'none';
  document.getElementById('propsTableView').style.display = mode==='table'?'block':'none';
  document.getElementById('vt-grid').classList.toggle('active', mode==='grid');
  document.getElementById('vt-table').classList.toggle('active', mode==='table');
  renderProperties();
}

// ════════════════════════════════════════════
// SEARCH
// ════════════════════════════════════════════
function handleSearch(val) {
  if (!val.trim()) { renderLeads(); return; }
  const q = val.toLowerCase();
  const filtered = _leads.filter(l=>(l.name||'').toLowerCase().includes(q)||(l.phone||'').includes(q)||(l.location||'').toLowerCase().includes(q)||(l.budget||'').toLowerCase().includes(q));
  const tbody = document.getElementById('leadsTableBody');
  if(filtered.length===0){tbody.innerHTML=`<tr><td colspan="9" style="text-align:center;padding:30px;color:var(--text3)">No leads found for "${val}"</td></tr>`;return;}
  const orig=_leads;_leads=filtered;renderLeads();_leads=orig;
}

// ════════════════════════════════════════════
// NAVIGATION
// ════════════════════════════════════════════
function setView(name) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  const ni=document.getElementById('nav-'+name);
  if(ni)ni.classList.add('active');
}

function updateNavCounts() {
  const hot=_leads.filter(l=>l.priority==='Hot'||l.priority==='VIP').length;
  const today=new Date().toISOString().split('T')[0];
  const todayFu=_followups.filter(f=>f.date===today&&f.status!=='done').length;
  document.getElementById('nav-leads-count').textContent=hot>0?hot+' hot':_leads.length;
  document.getElementById('nav-fu-count').textContent=todayFu;
  document.getElementById('todayFuBadge').textContent=todayFu;
  document.getElementById('nav-props-count').textContent=_properties.length;
}

// ════════════════════════════════════════════
// FILTER CHIPS — LEADS
// ════════════════════════════════════════════
document.getElementById('leadsToolbar').addEventListener('click', e => {
  const chip=e.target.closest('.filter-chip');
  if(!chip)return;
  document.querySelectorAll('#leadsToolbar .filter-chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  renderLeads(chip.dataset.filter);
});

// FILTER CHIPS — PROPERTIES
document.getElementById('propsToolbar').addEventListener('click', e => {
  const chip=e.target.closest('.filter-chip');
  if(!chip)return;
  document.querySelectorAll('#propsToolbar .filter-chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  renderProperties(chip.dataset.pfilter);
});

// FILTER — FOLLOW-UP TYPE
document.querySelectorAll('.fu-type-item').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.fu-type-item').forEach(i=>i.classList.remove('active'));
    item.classList.add('active');
    renderFollowUps(item.dataset.type);
  });
});

// ════════════════════════════════════════════
// MINI CALENDAR
// ════════════════════════════════════════════
function buildMiniCal() {
  const now=new Date();
  document.getElementById('calMonth').textContent=now.toLocaleString('default',{month:'long',year:'numeric'});
  const firstDay=new Date(now.getFullYear(),now.getMonth(),1).getDay();
  const daysInMonth=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
  const today=now.getDate();
  let html=['S','M','T','W','T','F','S'].map(d=>`<div class="mcg-day-name">${d}</div>`).join('');
  for(let i=0;i<firstDay;i++)html+='<div></div>';
  for(let d=1;d<=daysInMonth;d++)html+=`<div class="mcg-day${d===today?' today':''}">${d}</div>`;
  document.getElementById('miniCal').innerHTML=`<div class="mini-cal-grid">${html}</div>`;
}

// ════════════════════════════════════════════
// UTILITIES
// ════════════════════════════════════════════
function setDbStatus(ok,msg){const dot=document.getElementById('dbDot');const txt=document.getElementById('dbStatusText');dot.className='db-dot '+(ok?'connected':'error');txt.textContent=msg;}
function updateDate(){const now=new Date();const h=now.getHours();const greet=h<12?'Good morning':h<17?'Good afternoon':'Good evening';document.getElementById('dashGreeting').textContent=greet+' ☀️';document.getElementById('dashDate').textContent=now.toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'})+' · Real Estate CRM';}
function formatDate(dateStr){const d=new Date(dateStr);return d.toLocaleDateString('en-IN',{weekday:'long',day:'2-digit',month:'long'});}
function esc(str){return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// ════════════════════════════════════════════
// VIP CONTACTS — FIRESTORE
// ════════════════════════════════════════════
let _vipContacts = [];
let _currentBroadcastLead = null;
let _waSentSet = new Set();
let _waMsgEditMode = false;
let _editingVipId = null;

async function loadVipContactsFromDB() {
  try {
    const { collection, onSnapshot, orderBy, query } = window._firebase;
    const q = query(collection(window._db, 'vipcontacts'), orderBy('createdAt', 'desc'));
    onSnapshot(q, (snapshot) => {
      _vipContacts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      renderVipContacts();
      updateNavCounts();
    });
  } catch(e) { showToast('Could not load VIP contacts: ' + e.message, 'error'); }
}

async function addVipContactToDB(data) {
  const { collection, addDoc, serverTimestamp } = window._firebase;
  await addDoc(collection(window._db, 'vipcontacts'), { ...data, createdAt: serverTimestamp() });
}

async function updateVipContactInDB(id, data) {
  const { doc, updateDoc } = window._firebase;
  await updateDoc(doc(window._db, 'vipcontacts', id), data);
}

async function deleteVipContactFromDB(id) {
  const { doc, deleteDoc } = window._firebase;
  await deleteDoc(doc(window._db, 'vipcontacts', id));
}

function renderVipContacts() {
  const list = document.getElementById('vipContactsList');
  const countEl = document.getElementById('vip-contacts-count');
  const navEl = document.getElementById('nav-vip-count');
  if (countEl) countEl.textContent = _vipContacts.length;
  if (navEl) navEl.textContent = _vipContacts.length;
  const subEl = document.getElementById('vip-subtitle');
  if (subEl) subEl.textContent = _vipContacts.length + ' VIP contacts in broadcast list';

  if (!list) return;
  if (_vipContacts.length === 0) {
    list.innerHTML = '<div class="empty-state" style="padding:30px 16px"><div class="empty-state-icon">💚</div><h3>No VIP contacts yet</h3><p>Add investors, co-agents, or VIP clients to receive WhatsApp alerts.</p><button class="btn-save" style="background:#25d366;color:#000" onclick="openVipAddModal()">+ Add Contact</button></div>';
    return;
  }
  const typeColors = { 'Investor': '#a78bfa', 'Co-Agent': '#6ba3d6', 'VIP Client': '#d4a843', 'Team Member': '#4caf7d', 'Partner': '#e8924a' };
  list.innerHTML = _vipContacts.map(c => {
    const initials = c.name.split(' ').map(function(w){return w[0];}).join('').toUpperCase().slice(0,2);
    const color = typeColors[c.type] || '#25d366';
    return '<div class="vip-contact-card">' +
      '<div class="vcc-avatar" style="background:linear-gradient(135deg,#1a6b3a,' + color + ')">' + initials + '</div>' +
      '<div class="vcc-info">' +
        '<div class="vcc-name">' + esc(c.name) + '</div>' +
        '<div class="vcc-phone">' + esc(c.phone) + '</div>' +
        '<span class="vcc-tag">' + esc(c.type||'Contact') + '</span>' +
        (c.notes ? '<div style="font-size:10px;color:var(--text3);margin-top:2px">' + esc(c.notes) + '</div>' : '') +
      '</div>' +
      '<div class="vcc-actions">' +
        '<button class="vcc-btn wa-btn" title="Send WhatsApp" onclick="openWaForContact('' + c.id + '')">💬</button>' +
        '<button class="vcc-btn" title="Edit" onclick="openVipAddModal('' + c.id + '')">✏️</button>' +
        '<button class="vcc-btn del-btn" title="Delete" onclick="confirmDeleteVip('' + c.id + '','' + esc(c.name) + '')">🗑</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

function openVipAddModal(vipId) {
  _editingVipId = vipId || null;
  document.getElementById('vipAddModalTitle').textContent = vipId ? 'Edit VIP Contact' : 'Add VIP Contact';
  document.getElementById('vc-name').value = '';
  document.getElementById('vc-phone').value = '';
  document.getElementById('vc-notes').value = '';
  document.getElementById('vc-type').value = 'Investor';
  if (vipId) {
    const c = _vipContacts.find(function(x){return x.id === vipId;});
    if (c) {
      document.getElementById('vc-name').value = c.name || '';
      document.getElementById('vc-phone').value = c.phone || '';
      document.getElementById('vc-notes').value = c.notes || '';
      document.getElementById('vc-type').value = c.type || 'Investor';
    }
  }
  document.getElementById('vipAddModalOverlay').classList.add('open');
}
function closeVipAddModal() {
  document.getElementById('vipAddModalOverlay').classList.remove('open');
  _editingVipId = null;
}

async function saveVipContact() {
  const name = document.getElementById('vc-name').value.trim();
  const phone = document.getElementById('vc-phone').value.trim();
  if (!name || !phone) { showToast('Name and phone required', 'error'); return; }
  const data = { name, phone, type: document.getElementById('vc-type').value, notes: document.getElementById('vc-notes').value.trim() };
  const btn = document.getElementById('saveVipBtn');
  btn.disabled = true; btn.textContent = 'Saving...';
  try {
    if (_editingVipId) { await updateVipContactInDB(_editingVipId, data); showToast('Contact updated!', 'success'); }
    else { await addVipContactToDB(data); showToast('VIP contact added!', 'success'); }
    closeVipAddModal();
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
  finally { btn.disabled = false; btn.textContent = '💚 Save Contact'; }
}

function confirmDeleteVip(id, name) {
  if (!confirm('Remove "' + name + '" from VIP broadcast list?')) return;
  deleteVipContactFromDB(id).then(function(){ showToast('Contact removed', 'success'); }).catch(function(e){ showToast('Error: ' + e.message, 'error'); });
}

function buildWaMessage(lead, templateOverride) {
  const tmpl = templateOverride || (document.getElementById('bcTemplateText') ? document.getElementById('bcTemplateText').value : '') || '🔔 New Lead: {leadName}, Phone: {phone}, Budget: {budget}';
  return tmpl
    .replace(/{leadName}/g, lead.name || '')
    .replace(/{phone}/g, lead.phone || '')
    .replace(/{budget}/g, lead.budget || 'Not specified')
    .replace(/{location}/g, lead.location || 'Not specified')
    .replace(/{propType}/g, lead.proptype || 'Not specified')
    .replace(/{source}/g, lead.source || 'Not specified')
    .replace(/{stage}/g, lead.stage || 'New');
}

function getWaLink(phone, message) {
  const cleaned = phone.replace(/[\s\-()]/g, '');
  return 'https://wa.me/' + cleaned + '?text=' + encodeURIComponent(message);
}

function openWaBroadcast(lead) {
  _currentBroadcastLead = lead;
  _waSentSet = new Set();
  _waMsgEditMode = false;
  const initials = lead.name.split(' ').map(function(w){return w[0];}).join('').toUpperCase().slice(0,2);
  document.getElementById('waBcLeadAv').textContent = initials;
  document.getElementById('waBcLeadName').textContent = lead.name;
  document.getElementById('waBcLeadMeta').textContent = [lead.budget, lead.location, lead.proptype].filter(Boolean).join(' · ') || 'No extra details';
  document.getElementById('waBcSubtitle').textContent = 'Notify ' + _vipContacts.length + ' VIP contact' + (_vipContacts.length !== 1 ? 's' : '');
  document.getElementById('waBcContactsCount').textContent = _vipContacts.length + ' contacts';
  renderWaMsgPreview();
  renderWaBcContacts();
  document.getElementById('waBcSentCount').innerHTML = '0 sent';
  document.getElementById('waBroadcastOverlay').classList.add('open');
}

function renderWaMsgPreview() {
  if (!_currentBroadcastLead) return;
  const msg = buildWaMessage(_currentBroadcastLead);
  const bodyEl = document.getElementById('waMsgBody');
  if (!bodyEl) return;
  if (_waMsgEditMode) {
    bodyEl.innerHTML = '<textarea id="waMsgEditArea" style="width:100%;background:transparent;border:none;outline:none;color:var(--text2);font-family:DM Sans,sans-serif;font-size:13px;line-height:1.7;resize:none;min-height:120px">' + esc(msg) + '</textarea>';
  } else {
    bodyEl.textContent = msg;
  }
}

function toggleWaMsgEdit() {
  _waMsgEditMode = !_waMsgEditMode;
  renderWaMsgPreview();
}

function getCurrentWaMessage() {
  if (_waMsgEditMode) {
    const el = document.getElementById('waMsgEditArea');
    return el ? el.value : buildWaMessage(_currentBroadcastLead);
  }
  return buildWaMessage(_currentBroadcastLead);
}

function renderWaBcContacts() {
  const container = document.getElementById('waBcContactsList');
  if (!container) return;
  if (_vipContacts.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;font-size:13px;color:var(--text3)">No VIP contacts yet. <span style="color:var(--gold);cursor:pointer" onclick="closeWaBroadcast();setView('vipcontacts');openVipAddModal()">Add one →</span></div>';
    return;
  }
  container.innerHTML = _vipContacts.map(function(c, i) {
    const initials = c.name.split(' ').map(function(w){return w[0];}).join('').toUpperCase().slice(0,2);
    const sent = _waSentSet.has(c.id);
    return '<div class="wa-contact-row" style="animation-delay:' + (i*0.04) + 's" id="wc-row-' + c.id + '">' +
      '<div class="wc-av">' + initials + '</div>' +
      '<div class="wc-info">' +
        '<div class="wc-name">' + esc(c.name) + ' <span style="font-size:10px;color:var(--text3);font-weight:400">· ' + esc(c.type||'Contact') + '</span></div>' +
        '<div class="wc-phone">' + esc(c.phone) + '</div>' +
      '</div>' +
      '<button class="wc-send-btn ' + (sent ? 'sent' : '') + '" id="wc-btn-' + c.id + '" onclick="sendToOneVip('' + c.id + '')">' +
        (sent ? '✓ Sent' : '💬 Send') +
      '</button>' +
    '</div>';
  }).join('');
}

function sendToOneVip(contactId) {
  if (!_currentBroadcastLead) return;
  const contact = _vipContacts.find(function(c){return c.id === contactId;});
  if (!contact) return;
  const msg = getCurrentWaMessage();
  window.open(getWaLink(contact.phone, msg), '_blank');
  _waSentSet.add(contactId);
  const btn = document.getElementById('wc-btn-' + contactId);
  if (btn) { btn.textContent = '✓ Sent'; btn.classList.add('sent'); }
  updateWaSentCount();
}

function sendToAllVips() {
  if (!_currentBroadcastLead || _vipContacts.length === 0) { showToast('No VIP contacts', 'error'); return; }
  const msg = getCurrentWaMessage();
  var delay = 0;
  _vipContacts.forEach(function(c) {
    setTimeout(function() {
      window.open(getWaLink(c.phone, msg), '_blank');
      _waSentSet.add(c.id);
      const btn = document.getElementById('wc-btn-' + c.id);
      if (btn) { btn.textContent = '✓ Sent'; btn.classList.add('sent'); }
      updateWaSentCount();
    }, delay);
    delay += 600;
  });
  showToast('💬 Sending to ' + _vipContacts.length + ' VIP contacts!', 'success');
}

function updateWaSentCount() {
  const el = document.getElementById('waBcSentCount');
  if (el) el.innerHTML = '<strong>' + _waSentSet.size + '</strong> / ' + _vipContacts.length + ' sent';
}

function closeWaBroadcast() {
  document.getElementById('waBroadcastOverlay').classList.remove('open');
  _currentBroadcastLead = null;
}

function openWaForContact(contactId) {
  const contact = _vipContacts.find(function(c){return c.id === contactId;});
  if (!contact) return;
  if (_leads.length === 0) { showToast('No leads yet to share', 'error'); return; }
  const lead = _leads[0];
  window.open(getWaLink(contact.phone, buildWaMessage(lead)), '_blank');
  showToast('Opening WhatsApp for ' + contact.name, 'success');
}

function openBroadcastPickLead() {
  renderPickLeadList('');
  document.getElementById('pickLeadSearch').value = '';
  document.getElementById('pickLeadOverlay').classList.add('open');
}

function renderPickLeadList(search) {
  const list = document.getElementById('pickLeadList');
  if (!list) return;
  var items = _leads;
  if (search) items = items.filter(function(l){return (l.name||'').toLowerCase().indexOf(search.toLowerCase()) >= 0;});
  if (items.length === 0) { list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text3);font-size:13px">No leads found</div>'; return; }
  var pillMap = {'New':'pill-new','Contacted':'pill-contacted','Site Visit':'pill-site','Negotiation':'pill-nego','Closed':'pill-closed','Lost':'pill-lost'};
  list.innerHTML = items.map(function(l) {
    const initials = l.name.split(' ').map(function(w){return w[0];}).join('').toUpperCase().slice(0,2);
    return '<div onclick="selectLeadForBroadcast('' + l.id + '')" style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;border:1px solid var(--border);margin-bottom:6px;background:var(--bg3);transition:all .15s" onmouseover="this.style.borderColor='var(--border2)'" onmouseout="this.style.borderColor='var(--border)'">' +
      '<div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#000;flex-shrink:0">' + initials + '</div>' +
      '<div style="flex:1;min-width:0">' +
        '<div style="font-size:13px;font-weight:600;color:var(--text)">' + esc(l.name) + '</div>' +
        '<div style="font-size:11px;color:var(--text3)">' + esc(l.budget||'') + (l.location ? ' · '+l.location : '') + '</div>' +
      '</div>' +
      '<span class="status-pill ' + (pillMap[l.stage]||'pill-new') + '">' + l.stage + '</span>' +
    '</div>';
  }).join('');
}

function selectLeadForBroadcast(leadId) {
  const lead = _leads.find(function(l){return l.id === leadId;});
  if (!lead) return;
  document.getElementById('pickLeadOverlay').classList.remove('open');
  openWaBroadcast(lead);
}

function insertVar(varStr) {
  const ta = document.getElementById('bcTemplateText');
  if (!ta) return;
  const start = ta.selectionStart;
  const end = ta.selectionEnd;
  ta.value = ta.value.slice(0, start) + varStr + ta.value.slice(end);
  ta.selectionStart = ta.selectionEnd = start + varStr.length;
  ta.focus();
}

let toastTimer;
function showToast(msg,type='success'){const t=document.getElementById('toast');const icon=type==='error'?'❌':type==='info'?'💡':'✅';document.getElementById('toastIcon').textContent=icon;document.getElementById('toastMsg').textContent=msg;t.className='toast show '+type;clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('show'),3500);}

// ════════════════════════════════════════════
// LOAD
// ════════════════════════════════════════════
window.addEventListener('load', () => {
  updateDate();
  buildMiniCal();
  if(window._dbReady&&window._db){setDbStatus(true,'Connected');_dbConnected=true;loadLeadsFromDB();loadFollowUpsFromDB();loadPropertiesFromDB();loadVipContactsFromDB();}
});
</script>
</body>
</html>
